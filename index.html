<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELSWORD„Çπ„ÉÜ„Éº„Çø„ÇπÂäπÁéáË®àÁÆó</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0d0d0d;
            --card-bg: #1a1a1a;
            --card-hover: #252525;
            --input-bg: #000000;
            --text-main: #ffffff;
            --text-sub: #aaa;

            --accent-cyan: #00e5ff;
            --accent-yellow: #ffea00;
            --alert-red: #ff4444;
            --border-dim: #333;

            --toggle-off: #444;
            --toggle-on: var(--accent-cyan);
        }

        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: 0.05em;
        }

        .container {
            width: 100%;
            max-width: 950px;
        }

        /* --- „Éò„É´„Éó„Éú„Çø„É≥„Ç®„É™„Ç¢ --- */
        .nav-area {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
            padding: 0 5px;
        }

        .help-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-cyan), #00b8cc);
            border: none;
            color: #000;
            font-weight: 800;
            /* ExtraBold */
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 0 5px rgba(0, 229, 255, 0.5);
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }

        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--accent-cyan);
        }

        /* --- „Éò„ÉÉ„ÉÄ„Éº --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #111;
            border-bottom: 1px solid var(--border-dim);
            margin-bottom: 10px;
            border-radius: 8px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .stat-bar {
            background-color: #333;
            height: 20px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .stat-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00e5ff, #00bcd4);
            transition: width 0.5s ease-out;
            position: relative;
            box-shadow: 0 0 8px rgba(0, 229, 255, 0.4);
        }



        h1 {
            font-size: 1.3rem;
            color: #e0e0e0;
            margin: 0;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            font-weight: 800;
            /* ExtraBold */
        }

        .total-display-compact {
            font-size: 1.5rem;
            font-weight: 800;
            color: #fff;
        }

        .total-label-compact {
            font-size: 0.8rem;
            color: #888;
            margin-right: 10px;
            font-weight: 700;
        }

        /* --- „É™„Çπ„Éà --- */
        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 4px;
            overflow: hidden;
            border-left: 3px solid transparent;
            transition: border-color 0.3s ease;
        }

        .stat-header {
            position: relative;
            height: 44px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            overflow: hidden;
        }

        .stat-header:hover {
            background-color: var(--card-hover);
        }

        .bg-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--accent-cyan);
            opacity: 0.1;
            z-index: 0;
            width: 0%;
            transition: width 0.5s ease, background-color 0.3s ease;
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }

        .stat-icon-img {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            object-fit: contain;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
        }

        .stat-name {
            font-weight: 800;
            /* „Çø„Ç§„Éà„É´„Å®Âêå„ÅòExtraBold„Å´Â§âÊõ¥ */
            font-size: 0.95rem;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
            display: flex;
            align-items: center;
            letter-spacing: 0.05em;
            /* ÊñáÂ≠óÈñìÈöîË™øÊï¥ */
        }

        .meta-group {
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .label-text {
            font-size: 0.75rem;
            color: #888;
            margin-right: 4px;
            font-weight: 500;
        }

        .val-text {
            font-size: 1rem;
            color: #fff;
            min-width: 60px;
            text-align: right;
            font-weight: 700;
        }

        .eff-text {
            font-size: 0.9rem;
            color: var(--accent-cyan);
            min-width: 60px;
            text-align: right;
            font-weight: 700;
        }

        .spacer {
            width: 20px;
        }

        .arrow {
            font-size: 0.8rem;
            color: #555;
            margin-left: 10px;
            transition: transform 0.3s;
        }

        .stat-card[data-rank="1"]:not([data-over="true"]) {
            border-left-color: var(--accent-yellow);
        }

        .stat-card[data-rank="1"]:not([data-over="true"]) .eff-text {
            color: var(--accent-yellow);
        }

        .stat-card[data-rank="1"]:not([data-over="true"]) .bg-bar {
            background-color: var(--accent-yellow);
            opacity: 0.15;
        }

        .stat-card:not([data-rank="1"]) {
            border-left-color: var(--accent-cyan);
        }

        /* --- Ë©≥Á¥∞„Ç®„É™„Ç¢ --- */
        .details-section {
            background-color: #111;
            border-top: 1px solid #222;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }

        .details-section.open {
            max-height: 2000px;
            padding: 10px;
            overflow: visible;
        }

        .details-section.open+.header-content .arrow {
            transform: rotate(180deg);
        }

        .breakdown-row {
            display: grid;
            gap: 8px;
            margin-bottom: 4px;
            align-items: center;
        }

        .breakdown-row.crit {
            grid-template-columns: 1fr 70px 15px 60px 40px 30px;
        }

        .breakdown-row.simple {
            grid-template-columns: 1fr 70px 15px 40px 30px;
        }

        .breakdown-row.toggle-row {
            grid-template-columns: 1fr 100px 30px;
        }

        .breakdown-row.disabled input[type="text"],
        .breakdown-row.disabled input[type="number"],
        .breakdown-row.disabled select,
        .breakdown-row.disabled .unit-label,
        .breakdown-row.disabled .item-icon,
        .breakdown-row.disabled .type-label {
            opacity: 0.4;
        }

        .name-container {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .item-icon {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            object-fit: contain;
            opacity: 0.8;
        }

        .breakdown-row input[type="text"] {
            background: transparent;
            border: none;
            color: #aaa;
            border-bottom: 1px solid #333;
            padding: 2px 5px;
            width: 100%;
            font-size: 0.9rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 500;
            /* ÈÄöÂ∏∏„Çà„ÇäÂ∞ë„ÅóÂ§™„Åè */
            letter-spacing: 0.05em;
            /* Êº¢Â≠ó„ÅÆ„Å§„Å∂„ÇåÈò≤Ê≠¢ */
            transition: opacity 0.2s;
        }

        .breakdown-row input[type="number"] {
            background: var(--input-bg);
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            padding: 4px;
            text-align: right;
            font-weight: 700;
            width: 100%;
            font-size: 0.9rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            transition: opacity 0.2s;
        }

        .breakdown-row select {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 2px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            transition: opacity 0.2s;
        }

        .type-label {
            color: #888;
            font-size: 0.8rem;
            text-align: center;
            font-weight: 700;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }

        .unit-label {
            color: #555;
            font-size: 0.8rem;
            text-align: center;
            font-weight: 700;
        }

        .remove-btn {
            background: #2a2a2a;
            border: 1px solid #333;
            color: #888;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
            line-height: 24px;
            height: 26px;
            border-radius: 6px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .remove-btn:hover {
            background-color: var(--alert-red);
            color: #fff;
            border-color: var(--alert-red);
        }

        .remove-placeholder {
            height: 26px;
            width: 100%;
        }

        .add-btn {
            background: #222;
            border: 1px dashed #444;
            color: #666;
            width: 100%;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.85rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
        }

        .add-btn:hover {
            background: #333;
            color: #fff;
        }

        .formula-note {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .fixed-val {
            color: #555 !important;
            pointer-events: none;
            border: none !important;
            background: transparent !important;
        }

        /* --- „Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅ --- */
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--toggle-off);
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--toggle-on);
            box-shadow: 0 0 8px var(--toggle-on);
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        .switch-label {
            margin-right: 10px;
            font-size: 0.8rem;
            color: #aaa;
            font-weight: 700;
        }

        /* --- „É¢„Éº„ÉÄ„É´ --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #1a1a1a;
            margin: 5% auto;
            padding: 0;
            border: 1px solid var(--accent-cyan);
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
            color: #fff;
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 15px 20px;
            background: #111;
            border-bottom: 1px solid #333;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--accent-cyan);
        }

        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close-btn:hover {
            color: #fff;
        }

        .modal-body {
            padding: 20px;
        }

        .guide-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .guide-grid {
                grid-template-columns: 1fr;
            }
        }

        .guide-step {
            background: #222;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #555;
        }

        .step-num {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            font-weight: 800;
            margin-bottom: 5px;
            display: block;
        }

        .step-text {
            font-size: 0.95rem;
            line-height: 1.6;
            font-weight: 500;
        }

        .highlight-yellow {
            color: var(--accent-yellow);
            font-weight: 800;
        }

        .highlight-red {
            color: var(--alert-red);
            font-weight: 800;
        }

        .modal-footer {
            padding: 15px;
            text-align: center;
            border-top: 1px solid #333;
            font-size: 0.9rem;
            color: #888;
            font-weight: 500;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .tab-btn {
            background: #222;
            border: 1px solid #444;
            color: #888;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            font-family: inherit;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .tab-btn:hover {
            background: #333;
            color: #fff;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-cyan), #00b8cc);
            color: #000;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 8px rgba(0, 229, 255, 0.4);
        }

        .copy-btn {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            color: #fff;
            border-color: #666;
            background: #222;
        }

        /* „Ç¢„É©„Éº„ÉàÂûã„É¢„Éº„ÉÄ„É´Ôºà„Ç≥„Éî„ÉºÁ¢∫Ë™çÁî®Ôºâ */
        .alert-modal-content {
            background-color: #1a1a1a;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--accent-cyan);
            border-radius: 8px;
            width: 300px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            animation: modalFadeIn 0.3s;
        }

        .alert-btns {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .alert-btn {
            padding: 6px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            border: none;
        }

        .btn-yes {
            background: var(--accent-cyan);
            color: #000;
        }

        .btn-no {
            background: #333;
            color: #fff;
        }

        .compare-info {
            text-align: right;
            margin-right: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .item-row-img {
            width: 24px;
            height: 24px;
            object-fit: contain;
            margin-right: 8px;
            border-radius: 2px;
            background: #222;
            border: 1px solid #333;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="nav-area">
            <button id="helpBtn" class="help-btn">?</button>
        </div>

        <header>
            <div style="display:flex; flex-direction:column; align-items:flex-start;">
                <h1>ELSWORD„Çπ„ÉÜ„Éº„Çø„ÇπÂäπÁéáË®àÁÆó</h1>
                <div class="tab-container">
                    <button id="btnSetA" class="tab-btn active" onclick="switchSet('A')">Â§âÊõ¥Ââç</button>
                    <button id="btnSetB" class="tab-btn" onclick="switchSet('B')">Â§âÊõ¥Âæå</button>
                    <button class="copy-btn" onclick="openCopyModal()">Â§âÊõ¥Ââç„Çí„Ç≥„Éî„Éº</button>
                </div>
            </div>

            <div style="display:flex; align-items:center;">
                <div id="compareInfo" class="compare-info">
                    <!-- JS Injected -->
                </div>
                <div style="text-align:right;">
                    <span class="total-label-compact"
                        style="display:block; margin-right:0; font-size:0.65rem; line-height:1;">TOTAL MULTI</span>
                    <span class="total-display-compact" id="totalDisplay">0.00</span>
                </div>
            </div>
        </header>

        <div class="stats-list" id="statsList"></div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìå ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</div>
                <span class="close-btn" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="guide-grid">
                    <div class="guide-step" style="border-left-color: var(--accent-cyan);">
                        <span class="step-num">STEP 1</span>
                        <div class="step-text">
                            È†ÖÁõÆ„ÅÆ„Éê„Éº„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÄÅË©≥Á¥∞„ÇíÈñã„Åç„Åæ„Åô„ÄÇ<br>
                            Êï∞ÂÄ§ÂÖ•Âäõ„ÇÑ„Çπ„Ç§„ÉÉ„ÉÅ(ON/OFF)„Åß„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Åß„Åç„Åæ„Åô„ÄÇ
                        </div>
                    </div>
                    <div class="guide-step" style="border-left-color: var(--accent-cyan);">
                        <span class="step-num">STEP 2</span>
                        <div class="step-text">
                            Âè≥ÂÅ¥„ÅÆ<strong>„Äå1%‰∏äÊòáÂäπÁéá„Äç</strong>„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºÅ<br>
                            „Åì„ÅÆÊï∞ÂÄ§„ÅåÂ§ß„Åç„ÅÑÈ†ÖÁõÆ„ÇíÂº∑Âåñ„Åô„Çã„ÅÆ„ÅåÊúÄ„ÇÇÂäπÁéáÁöÑ„Åß„Åô„ÄÇ
                        </div>
                    </div>
                    <div class="guide-step" style="border-left-color: var(--accent-yellow);">
                        <span class="step-num">STEP 3</span>
                        <div class="step-text">
                            ÂäπÁéáNo.1„ÅØ<span class="highlight-yellow">ÈªÑËâ≤„ÅÆ„Éê„Éº</span>„ÄÅ<br>
                            Ê∏õË°∞„É©„Ç§„É≥(280%)Ë∂Ö„Åà„ÅØ<span class="highlight-red">Ëµ§Ëâ≤„ÅÆ„Éê„Éº</span>„ÅßË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
                        </div>
                    </div>
                    <div class="guide-step" style="border-left-color: #fff;">
                        <span class="step-num">TIP</span>
                        <div class="step-text">
                            Â§âÊõ¥Ââç„Å®Â§âÊõ¥Âæå„ÇíÊØî„Åπ„Å¶„ÄÅ„Å©„Å°„Çâ„ÅåÂº∑„ÅÑ„Åã„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Åó„Åæ„Åó„Çá„ÅÜÔºÅ
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                Ë®àÁÆóÊ©ü„Çí‰Ωø„Å£„Å¶ÊúÄÂº∑„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÁõÆÊåá„Åù„ÅÜÔºÅüî•
            </div>
        </div>
    </div>

    <!-- Copy Confirmation Modal -->
    <div id="copyModal" class="modal">
        <div class="alert-modal-content">
            <div style="font-weight:bold; color:#fff; margin-bottom:15px;">Á¢∫Ë™ç</div>
            <div style="color:#aaa; font-size:0.9rem; line-height:1.5;">
                Â§âÊõ¥ÂâçÔºàSet AÔºâ„ÅÆ„Éá„Éº„Çø„Çí„Ç≥„Éî„Éº„Åó„Å¶„ÄÅ<br>Â§âÊõ¥ÂæåÔºàSet BÔºâ„Å´‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü
            </div>
            <div class="alert-btns">
                <button class="alert-btn btn-no" onclick="closeCopyModal()">No</button>
                <button class="alert-btn btn-yes" onclick="execCopy()">Yes</button>
            </div>
        </div>
    </div>

    <script>
        // ‚ñº „Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö ‚ñº
        const defaultImgUrl = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // Transparent 1x1

        /*
          „Éá„Éº„ÇøË®≠ÂÆö („ÉÜ„É≥„Éó„É¨„Éº„Éà)
        */
        const defaultStatsData = [
            {
                id: "atk_percent",
                name: "Áâ©È≠îÊîªÊíÉÂäõ(%)",
                customImage: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAyNCAyNCcgZmlsbD0nbm9uZScgc3Ryb2tlPScjMDBlNWZmJyBzdHJva2Utd2lkdGg9JzInIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTE0LjUgMTcuNUwzIDZWM2gzbDExLjUgMTEuNSIvPjxwYXRoIGQ9Ik0xMyAxOWw2LTYiLz48cGF0aCBkPSJNMTYgMTZsNCA0Ii8+PHBhdGggZD0iTTE5IDIxbDItMiIvPjwvc3ZnPg==",
                calcType: "simple",
                items: [
                    { label: "Âü∫Á§éÂÄ§(Âõ∫ÂÆö)", val: 100, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "Ê≠¶Âô®È≠îÂäõ‰ªò‰∏é ÂêàÁÆó", val: 37.5, fixed: true, edit: true, on: true, imgUrl: "./images/maryoku.png" },
                    { label: "„Ç®„ÇØ„ÇµÂÜçÈå¨ÂäπÊûú", val: 8, fixed: true, edit: true, on: true, imgUrl: "./images/ekusa.png" },
                    { label: "„É¨„Ç¢„Éê„Çª„ÉÉ„ÉàÂäπÊûú", val: 6, fixed: true, edit: true, on: true, imgUrl: "./images/sinen.png" },
                    { label: "„É¨„Ç¢„Éê„Ç¢„ÇØ„ÇªÂäπÊûú", val: 9, fixed: true, edit: true, on: true, imgUrl: "./images/reabakouka.png" },
                    { label: "„Ç®„É´„Ç≥„É¨ÂäπÊûú", val: 3.75, fixed: true, edit: true, on: true, imgUrl: "./images/erukore.png" },
                    { label: "„Ç™„Éó„Ç∑„Éß„É≥Â§âÊèõÂäπÊûú", val: 12, fixed: true, edit: true, on: true, imgUrl: "./images/buki.png" },
                    { label: "„Çπ„Ç≠„É™„É≥[Âõ∫ÂÆöÂäπÊûú]", val: 0.5, fixed: true, edit: false, on: true, imgUrl: "./images/sukiru.png" },
                    { label: "„Éö„ÉÉ„Éà„Éë„ÉÉ„Ç∑„Éñ", val: 2, fixed: true, edit: false, on: true, imgUrl: "./images/pet.png" },
                    { label: "„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÊàêÈï∑1ÊÆµÈöé", val: 3, fixed: true, edit: false, on: true, imgUrl: "./images/arti.png" },
                    { label: "„Ç∑„Éä„Ç∏„Éº", val: 1, fixed: true, edit: false, on: true, imgUrl: "./images/shinagi.png" },
                ]
            },
            {
                id: "cri_dmg",
                name: "„ÇØ„É™„ÉÜ„Ç£„Ç´„É´„ÉÄ„É°„Éº„Ç∏",
                customImage: "./images/header_cri.png",
                calcType: "crit",
                items: [
                    { label: "„Çπ„ÉÜË°®Ë®ò", val: 215.00, type: "stat_window", fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "Âä†ÁÆó„Éë„ÉÉ„Ç∑„Éñ", val: 0, type: "add", fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "‰πóÁÆó„Éë„ÉÉ„Ç∑„Éñ", val: 0, type: "multi", fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "„Ç¢„ÉÉ„Éà„ÉûËçâÊú®", val: 26, type: "multi", fixed: true, edit: true, on: true, imgUrl: "./images/attoma.png" },
                    { label: "„Ç®„ÇØ„ÇµËµ§„Çª„ÉÉ„Éà", val: 10, type: "multi", fixed: true, edit: false, on: true, imgUrl: "./images/ekusa.png" },
                    { label: "ÂàªÂç∞", val: 5, type: "multi", fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„Éû„Ç®„Çπ„Éà„É≠„Éò„Ç§„É≠„Éº", val: 2, type: "multi", fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                ]
            },
            {
                id: "boss_dmg",
                name: "„Éú„Çπ„Å´‰∏é„Åà„Çã„ÉÄ„É°„Éº„Ç∏Â¢óÂä†",
                customImage: "./images/header_boss.png",
                calcType: "simple",
                items: [
                    { label: "Âü∫Á§éÂÄ§(Âõ∫ÂÆö)", val: 100, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„Çπ„ÉÜ„Éº„Çø„ÇπË°®Ë®ò", val: 150.00, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "Âä†ÁÆó„Éë„ÉÉ„Ç∑„Éñ", val: 0.00, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "„ÇÆ„É´„Éâ„Çπ„Ç≠„É´", val: 2.50, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "ÂàªÂç∞", val: 5, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                ]
            },
            {
                id: "all_skill",
                name: "ÂÖ®„Å¶„ÅÆ„Çπ„Ç≠„É´„ÉÄ„É°„Éº„Ç∏Â¢óÂä†",
                customImage: "./images/header_all.png",
                calcType: "simple",
                items: [
                    { label: "Âü∫Á§éÂÄ§(Âõ∫ÂÆö)", val: 100, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„Çπ„ÉÜ„Éº„Çø„ÇπË°®Ë®ò", val: 104.50, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl }
                ]
            },
            {
                id: "trans_skill",
                name: "Âº∑ÁÉà„ÄÅË∂ÖË∂ä„Çπ„Ç≠„É´„ÉÄ„É°„Éº„Ç∏Â¢óÂä†",
                customImage: "./images/header_trans.png",
                calcType: "simple",
                items: [
                    { label: "Âü∫Á§éÂÄ§(Âõ∫ÂÆö)", val: 100, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„Çπ„ÉÜ„Éº„Çø„ÇπË°®Ë®ò", val: 122.00, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl }
                ]
            },
            {
                id: "polar",
                name: "‰∏°Ê•µÂåñÔºöÊîªÊíÉ/Âèó„Åë„Çã„ÉÄ„É°„Éº„Ç∏Â¢óÂä†",
                customImage: "./images/header_polar.png",
                calcType: "simple",
                items: [
                    { label: "Âü∫Á§éÂÄ§(Âõ∫ÂÆö)", val: 100, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„Çπ„ÉÜ„Éº„Çø„ÇπË°®Ë®ò", val: 53.70, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl }
                ]
            },
            {
                id: "dot",
                name: "‰∏é„Åà„Åü„ÉÄ„É°„Éº„Ç∏„ÅÆn%„ÇíËøΩÂä†ÊåÅÁ∂ö„ÉÄ„É°„Éº„Ç∏",
                customImage: "./images/header_dot.png",
                calcType: "simple",
                items: [
                    { label: "Âü∫Á§éÂÄ§(Âõ∫ÂÆö)", val: 100, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„Ç®„ÇØ„Çµ‰∏äË°£ÂõûË∑Ø", val: 12.00, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "„Ç®„ÇØ„Çµ„ÉÅ„ÉÉ„Éó", val: 12.00, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "„Ç¢„ÉÉ„Éà„Éû‰∏ä„Ç¢„ÇØ„Çª", val: 5.00, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "„É¨„Ç¢„Éê„Çª„ÉÉ„ÉàÂäπÊûú", val: 12.00, fixed: true, edit: true, on: true, imgUrl: "./images/sinen.png" },
                    { label: "„É¨„Ç¢„ÉêÊ≠¶Âô®ÂäπÊûú", val: 5.00, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "„É¨„Ç¢„Éê„Ç¢„ÇØ„ÇªÂäπÊûú", val: 7.00, fixed: true, edit: true, on: true, imgUrl: "./images/reabakouka.png" },
                    { label: "„Ç™„Éó„Ç∑„Éß„É≥Â§âÊèõÂäπÊûú", val: 12.00, fixed: true, edit: true, on: true, imgUrl: "./images/buki.png" },
                    { label: "„É¨„Ç§„Éâ3ÁÇπ„Çª„ÉÉ„ÉàÂäπÊûú", val: 5.00, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„É™„É≥„ÇØ„Ç¢„ÉêÂäπÊûú", val: 2.00, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„Ç∑„Éä„Ç∏„ÉºÔºöÊ≠™Êõ≤", val: 2.00, fixed: true, edit: false, on: true, imgUrl: "./images/shinagi.png" },
                ]
            },
            {
                id: "hp100_under",
                name: "HP100ÔºÖ‰ª•‰∏ã„ÅÆÊïµ„ÇíÊîªÊíÉÊôÇ„ÄÅ„ÉÄ„É°„Éº„Ç∏Â¢óÂä†",
                customImage: "./images/header_hp.png",
                calcType: "simple",
                items: [
                    { label: "Âü∫Á§éÂÄ§(Âõ∫ÂÆö)", val: 100, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„É¨„Ç¢„Éê„Çª„ÉÉ„ÉàÂäπÊûú", val: 10, fixed: true, edit: true, on: true, imgUrl: "./images/sinen.png" },
                    { label: "Ê≠¶Âô®ÂäπÊûú", val: 5, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                ]
            },
            {
                id: "hp50_over",
                name: "HP50ÔºÖË∂ÖÈÅé„ÅÆÊïµ„ÇíÊîªÊíÉÊôÇ„ÄÅ„ÉÄ„É°„Éº„Ç∏Â¢óÂä†",
                customImage: "./images/header_hp.png",
                calcType: "simple",
                items: [
                    { label: "Âü∫Á§éÂÄ§(Âõ∫ÂÆö)", val: 100, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„Ç®„ÇØ„ÇµÂõûË∑ØÂäπÊûú", val: 10, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "„Ç®„ÇØ„Çµ„ÉÅ„ÉÉ„ÉóÂäπÊûú", val: 5, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl }
                ]
            },
            {
                id: "hp50_under",
                name: "HP50ÔºÖ‰ª•‰∏ã„ÅÆÊïµ„ÇíÊîªÊíÉÊôÇ„ÄÅ„ÉÄ„É°„Éº„Ç∏Â¢óÂä†",
                customImage: "./images/header_hp.png",
                calcType: "simple",
                items: [
                    { label: "Âü∫Á§éÂÄ§(Âõ∫ÂÆö)", val: 100, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„Ç®„ÇØ„ÇµÂõûË∑ØÂäπÊûú", val: 10, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl },
                    { label: "„Ç®„ÇØ„Çµ„ÉÅ„ÉÉ„ÉóÂäπÊûú", val: 5, fixed: true, edit: true, on: true, imgUrl: defaultImgUrl }
                ]
            },
            {
                id: "hp30",
                name: "HP30ÔºÖ‰ª•‰∏ã„ÅÆÊïµ„ÇíÊîªÊíÉÊôÇ„ÄÅ„ÉÄ„É°„Éº„Ç∏Â¢óÂä†",
                customImage: "./images/header_hp.png",
                calcType: "simple",
                items: [
                    { label: "Âü∫Á§éÂÄ§(Âõ∫ÂÆö)", val: 100, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl },
                    { label: "„ÇΩ„Ç±„ÉÉ„ÉàÂäπÊûú", val: 0, fixed: true, edit: false, on: true, imgUrl: defaultImgUrl }
                ]
            },
        ];

        // ‚ñº „Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖãÁÆ°ÁêÜ ‚ñº
        let appState = {
            activeSet: 'A',
            sets: {
                A: null,
                B: null
            }
        };

        const listContainer = document.getElementById('statsList');
        const totalDisplay = document.getElementById('totalDisplay');
        const modal = document.getElementById("helpModal");
        const copyModal = document.getElementById("copyModal");
        const helpBtn = document.getElementById("helpBtn");
        const closeBtn = document.getElementById("closeModal");

        function init() {
            loadState(); // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø or ÂàùÊúüÂåñ
            setupModal();
            render();
            calculate();
        }

        // --- „Éá„Éº„ÇøÊ∞∏Á∂öÂåñ (LocalStorage) ---
        function saveState() {
            localStorage.setItem('elsword_calc_state_v5', JSON.stringify(appState));
        }

        function loadState() {
            const saved = localStorage.getItem('elsword_calc_state_v5');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.activeSet && parsed.sets && parsed.sets.A && parsed.sets.B) {
                        appState = parsed;
                        // --- „Éá„Éº„ÇøÂêåÊúü: „Éá„Éï„Ç©„É´„ÉàÁîªÂÉè„ÅÆÂèçÊò† ---
                        // ‰øùÂ≠ò„Åï„Çå„Åü„Éá„Éº„Çø„Å´ÁîªÂÉèÊÉÖÂ†±„Åå„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØ„Éá„Éï„Ç©„É´„Éà„ÅÆÈÄèÊòéÁîªÂÉè„ÅÆ„Åæ„Åæ„ÅÆÂ†¥Âêà„ÄÅ
                        // defaultStatsData„Å´„ÅÇ„ÇãÊñ∞„Åó„ÅÑURL„ÇíÈÅ©Áî®„Åô„Çã
                        syncDefaultImages();
                    } else {
                        throw new Error("Invalid format");
                    }
                } catch (e) {
                    console.log("Data corrupted or init, loading default.", e);
                    initDefault();
                }
            } else {
                initDefault();
            }
        }

        function syncDefaultImages() {
            // A„Å®B‰∏°Êñπ„ÅÆ„Çª„ÉÉ„Éà„Å´ÂØæ„Åó„Å¶ÂÆüË°å
            ['A', 'B'].forEach(setKey => {
                if (!appState.sets[setKey]) return;
                appState.sets[setKey].forEach((cat, catIdx) => {
                    // ÂØæÂøú„Åô„Çã„Éá„Éï„Ç©„É´„Éà„Éá„Éº„Çø„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÊé¢„Åô
                    const defCat = defaultStatsData.find(d => d.id === cat.id);
                    if (!defCat) return;

                    cat.items.forEach((item, itemIdx) => {
                        // ÂØæÂøú„Åô„Çã„Éá„Éï„Ç©„É´„Éà„Ç¢„Ç§„ÉÜ„É†„ÇíÊé¢„ÅôÔºà„É©„Éô„É´‰∏ÄËá¥Ôºâ
                        const defItem = defCat.items.find(d => d.label === item.label);
                        if (defItem && defItem.imgUrl && defItem.imgUrl !== defaultImgUrl) {
                            // ‰øùÂ≠ò„Éá„Éº„Çø„ÅÆÁîªÂÉè„ÅåÁ©∫or„Éá„Éï„Ç©„É´„ÉàÁîªÂÉè„Å™„Çâ„ÄÅÊñ∞„Åó„ÅÑ„Éá„Éï„Ç©„É´„ÉàÁîªÂÉè„Åß‰∏äÊõ∏„Åç
                            if (!item.imgUrl || item.imgUrl === defaultImgUrl) {
                                item.imgUrl = defItem.imgUrl;
                            }
                        }
                    });
                });
            });
            // ÂêåÊúü„Åó„ÅüÁµêÊûú„Çí‰øùÂ≠ò
            saveState();
        }

        function initDefault() {
            // „Éá„Ç£„Éº„Éó„Ç≥„Éî„Éº„ÅßÂàùÊúüÂåñ
            appState.sets.A = JSON.parse(JSON.stringify(defaultStatsData));
            appState.sets.B = JSON.parse(JSON.stringify(defaultStatsData));
            appState.activeSet = 'A';
        }

        function setupModal() {
            helpBtn.onclick = function () { modal.style.display = "block"; }
            closeBtn.onclick = function () { modal.style.display = "none"; }
            window.onclick = function (event) {
                if (event.target == modal) { modal.style.display = "none"; }
                if (event.target == copyModal) { copyModal.style.display = "none"; }
            }
        }

        // --- „Ç≥„Éî„ÉºÊ©üËÉΩ ---
        function openCopyModal() {
            copyModal.style.display = "block";
        }

        function closeCopyModal() {
            copyModal.style.display = "none";
        }

        function execCopy() {
            // A -> B Deep Copy
            appState.sets.B = JSON.parse(JSON.stringify(appState.sets.A));
            saveState();
            // ÊèèÁîªÊõ¥Êñ∞
            render();
            calculate();
            closeCopyModal();
        }

        // --- A/B Âàá„ÇäÊõø„Åà ---
        function switchSet(setName) {
            appState.activeSet = setName;
            saveState();
            updateHeaderUI();
            render();
            calculate();
        }

        function getActiveData() {
            return appState.sets[appState.activeSet];
        }

        function render() {
            listContainer.innerHTML = '';
            const currentStats = getActiveData();

            currentStats.forEach((cat, index) => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.id = `card-${index}`;

                const header = document.createElement('div');
                header.className = 'stat-header';
                header.onclick = () => toggleDetails(index);
                header.innerHTML = `
                <div class="bg-bar" id="bar-${index}"></div>
                <div class="header-content">
                    <div class="stat-name">
                        ${cat.customImage ? `<img src="${cat.customImage}" class="stat-icon-img" alt="icon">` : ''}
                        ${cat.name}
                    </div>
                    <div class="meta-group">
                        <span class="label-text">ÂêàË®à:</span>
                        <span class="val-text" id="total-${index}">0%</span>
                        <div class="spacer"></div>
                        <span class="label-text">1%‰∏äÊòáÂäπÁéá:</span>
                        <span class="eff-text" id="eff-${index}">+0%</span>
                        <span class="arrow" id="arrow-${index}">‚ñº</span>
                    </div>
                </div>
            `;

                const details = document.createElement('div');
                details.className = 'details-section';
                details.id = `details-${index}`;

                const note = document.createElement('div');
                note.className = 'formula-note';
                if (cat.calcType === 'crit') {
                    note.innerText = 'Âºè: („Çπ„ÉÜË°®Ë®ò - 150) + Âä†ÁÆó + (150 √ó ‰πóÁÆóË£úÊ≠£)';
                } else {
                    note.innerText = 'Âºè: Âü∫Á§éÂÄ§(100%) + Âä†ÁÆóÂÄ§„ÅÆÂêàË®à';
                }
                details.appendChild(note);

                const rowsContainer = document.createElement('div');
                rowsContainer.id = `rows-${index}`;
                details.appendChild(rowsContainer);

                const addBtn = document.createElement('button');
                addBtn.className = 'add-btn';
                addBtn.innerText = 'Ôºã È†ÖÁõÆ„ÇíËøΩÂä†';
                addBtn.onclick = (e) => { e.stopPropagation(); addItem(index); };
                details.appendChild(addBtn);

                card.appendChild(header);
                card.appendChild(details);
                listContainer.appendChild(card);

                renderRows(index, currentStats);
            });
            updateHeaderUI();
        }

        function renderRows(catIndex, currentStats) {
            const container = document.getElementById(`rows-${catIndex}`);
            const cat = currentStats[catIndex];
            container.innerHTML = '';

            cat.items.forEach((item, itemIndex) => {
                const row = document.createElement('div');

                if (item.type === 'toggle') {
                    row.className = 'breakdown-row toggle-row';
                } else {
                    let rowClass = cat.calcType === 'crit' ? 'breakdown-row crit' : 'breakdown-row simple';
                    if (item.on === false) rowClass += ' disabled';
                    row.className = rowClass;
                }

                // --- ÁîªÂÉèË°®Á§∫ (New) ---    
                const imgDisplay = document.createElement('img');
                imgDisplay.src = item.imgUrl || defaultImgUrl;
                imgDisplay.className = 'item-row-img';
                imgDisplay.onerror = () => { imgDisplay.src = defaultImgUrl; }; // „Ç®„É©„ÉºÊôÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ

                // ÂêçÂâçÂÖ•Âäõ„Ç®„É™„Ç¢
                const nameContainer = document.createElement('div');
                nameContainer.className = 'name-container';
                nameContainer.appendChild(imgDisplay);

                // Âõ∫ÂÆöÈ†ÖÁõÆ„ÅÆÂ†¥Âêà„ÅØ„Éî„É≥„Ç¢„Ç§„Ç≥„É≥Ë°®Á§∫


                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = item.label;
                nameInput.placeholder = 'È†ÖÁõÆÂêç';
                if (item.fixed) nameInput.readOnly = true;
                nameInput.oninput = (e) => {
                    cat.items[itemIndex].label = e.target.value;
                    saveState();
                };

                nameContainer.appendChild(nameInput);
                row.appendChild(nameContainer);

                // --- ÁîªÂÉèURLË®≠ÂÆöÁî®ÂÖ•Âäõ (New Feature) ---
                // ÈÄöÂ∏∏„ÅØÈö†„Åó„Å¶„Åä„Åç„ÄÅ„Éï„Ç©„Éº„Ç´„ÇπÊôÇ„ÇÑ‰Ωï„Çâ„Åã„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅßË°®Á§∫„Åô„Çã„ÅÆ„ÇÇÊâã„Å†„Åå„ÄÅ
                // ‰ªäÂõû„ÅØ„Ç∑„É≥„Éó„É´„Å´‰∏ãÈÉ®„Åæ„Åü„ÅØÊ®™„Å´ÈÖçÁΩÆ„Åó„Åü„ÅÑ„Åå„ÄÅ„Çπ„Éö„Éº„Çπ„Åå„Å™„ÅÑ„Åü„ÇÅ
                // Ë©≥Á¥∞(„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥)ÂÜÖ„Å´ÂÖ•„Çå„Çã„Åã„ÄÅToggleRow‰ª•Â§ñ„Å™„Çâ„Çπ„Éö„Éº„Çπ„Çí‰Ωú„Çã„ÄÇ
                // „É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÂ¥©„Åï„Å™„ÅÑ„Åü„ÇÅ„ÄÅrow„ÅÆ‰∏ã„Å´Ë®≠ÂÆöÁî®row„ÇíËøΩÂä†„Åô„ÇãÂΩ¢„Å´„Åô„Çã„Åã„ÄÅ
                // „ÅÇ„Çã„ÅÑ„ÅØnameInput„ÅÆÊ®™„Å´ËøΩÂä†„Åô„Çã„Åã... 
                // Êó¢Â≠ò„ÅÆgrid„É¨„Ç§„Ç¢„Ç¶„Éà(crit: 1fr 70px...)„ÇíÂ§â„Åà„Çã„ÅÆ„ÅØ„É™„Çπ„ÇØ„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ
                // nameContainer„ÅÆ‰∏≠„Å´„ÄåÁîªÂÉèË®≠ÂÆö„Éú„Çø„É≥(„Åæ„Åü„ÅØÂ∞è„Åï„Å™ÂÖ•ÂäõÊ¨Ñ)„Äç„ÇíÂÖ•„Çå„Çã„ÅÆ„ÅåÂÆâÂÖ®„ÄÇ

                // „Åì„Åì„Åß„ÅØ nameContainer „Çí flex-direction: column „Å´„Åó„Å¶2ÊÆµ„Å´„Åô„ÇãÊ°à„ÇÇ„ÅÇ„Çã„Åå„ÄÅ
                // „Ç∑„É≥„Éó„É´„Å´„ÄåÁîªÂÉèURL„ÄçÂÖ•ÂäõÊ¨Ñ„Çí nameInput „ÅÆ‰∏ã„Å´ËøΩÂä†„Åô„ÇãÂΩ¢(Âà•ÈÄîdiv)„ÅØ„É¨„Ç§„Ç¢„Ç¶„ÉàÂ§âÊõ¥Â§ß„ÄÇ
                // „É¶„Éº„Ç∂„ÉºË¶ÅÊúõ„ÄåÁîªÂÉèË®≠ÂÆöÊ©üËÉΩ„Äç„ÇíÂÆüÁèæ„Åô„Çã„Åü„ÇÅ„ÄÅ
                // nameInput„ÅÆ"title"Â±ûÊÄß„Åß„Å™„Åè„ÄÅÂ∞ÇÁî®„ÅÆ input „ÇíËøΩÂä†„Åô„Çã„ÄÇ
                // „Çπ„Éö„Éº„ÇπÁØÄÁ¥Ñ„ÅÆ„Åü„ÇÅ„ÄÅnameInput„ÅÆÂè≥ÂÅ¥„Å´Â∞è„Åï„ÅÑ„Ç¢„Ç§„Ç≥„É≥„Éú„Çø„É≥„ÇíÁΩÆ„Åç„ÄÅÊäº„Åô„Å®„Éó„É≠„É≥„Éó„Éà...„Åß„ÅØ„Å™„Åè
                // UI„Å®„Åó„Å¶Ë¶ã„Åà„ÇãÂΩ¢„ÅåËâØ„ÅÑ„ÄÇ

                // ÁèæÂú®„ÅÆ„Éá„Ç∂„Ç§„É≥: [Img][Pin][NameInput] ...
                // Â§âÊõ¥Ê°à: [Img][Pin][NameInput] [ImgURLInput(small)]

                // ÁîªÂÉèURLÂÖ•ÂäõÊ¨Ñ
                // „Éá„Ç∂„Ç§„É≥Ë™øÊï¥: nameContainerÂÜÖ„Å´ËøΩÂä†
                const imgUrlInput = document.createElement('input');
                imgUrlInput.type = 'text';
                imgUrlInput.className = 'img-url-input'; // CSS„Åß„Çπ„Çø„Ç§„É™„É≥„Ç∞
                imgUrlInput.placeholder = 'ÁîªÂÉèURL';
                imgUrlInput.value = item.imgUrl === defaultImgUrl ? '' : (item.imgUrl || '');
                imgUrlInput.oninput = (e) => {
                    const url = e.target.value;
                    cat.items[itemIndex].imgUrl = url;
                    imgDisplay.src = url || defaultImgUrl;
                    saveState();
                };
                // „Çπ„Çø„Ç§„É´: ÂπÖ„ÇíÁü≠„Åè„ÄÅËñÑ„ÅèË°®Á§∫
                imgUrlInput.style.cssText = "width: 60px; font-size: 0.7rem; color: #555; background: transparent; border: 1px solid #333; border-radius: 4px; padding: 2px; margin-left: 5px;";

                nameContainer.appendChild(imgUrlInput);


                if (item.type === 'toggle') {
                    const switchContainer = document.createElement('div');
                    switchContainer.className = 'switch-container';

                    const label = document.createElement('span');
                    label.className = 'switch-label';
                    label.innerText = (item.val > 0 ? '+' : '') + item.val + '%';

                    const labelSwitch = document.createElement('label');
                    labelSwitch.className = 'switch';

                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.checked = item.on;
                    chk.onchange = (e) => {
                        cat.items[itemIndex].on = e.target.checked;
                        saveState();
                        renderRows(catIndex, currentStats);
                        calculate();
                    };

                    const slider = document.createElement('span');
                    slider.className = 'slider';

                    labelSwitch.appendChild(chk);
                    labelSwitch.appendChild(slider);
                    switchContainer.appendChild(label);
                    switchContainer.appendChild(labelSwitch);

                    row.appendChild(switchContainer);
                } else {
                    const valInput = document.createElement('input');
                    valInput.type = 'number';
                    valInput.value = item.val;
                    valInput.step = '0.1';

                    // „É¶„Éº„Ç∂„ÉºË¶ÅÊúõ: Áü¢Âç∞„Ç≠„Éº„Åß1.0Âàª„Åø„ÅÆÂ§âÊõ¥ (3.5 -> 4.5)
                    valInput.onkeydown = (e) => {
                        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                            e.preventDefault();
                            let current = parseFloat(e.target.value) || 0;
                            if (e.key === 'ArrowUp') current += 1;
                            else current -= 1;

                            // Â∞èÊï∞ÁÇπ„Ç∫„É¨Èò≤Ê≠¢
                            current = Math.round(current * 100) / 100;

                            e.target.value = current;
                            cat.items[itemIndex].val = current;
                            saveState();
                            calculate();
                        }
                    };

                    if (item.edit === false) {
                        valInput.className = 'fixed-val';
                        valInput.readOnly = true;
                    }
                    valInput.oninput = (e) => {
                        let v = parseFloat(e.target.value);
                        if (isNaN(v)) v = 0;
                        cat.items[itemIndex].val = v;
                        saveState();
                        calculate();
                    };
                    row.appendChild(valInput);

                    const unitLabel = document.createElement('div');
                    unitLabel.className = 'unit-label';
                    unitLabel.innerText = '%';
                    row.appendChild(unitLabel);
                }

                if (cat.calcType === 'crit' && item.type !== 'toggle') {
                    if (item.fixed) {
                        // Âõ∫ÂÆöÈ†ÖÁõÆ„ÅØ„Çø„Ç§„ÉóÂõ∫ÂÆö
                        const typeLabel = document.createElement('div');
                        typeLabel.className = 'type-label';
                        if (item.type === 'stat_window') typeLabel.innerText = '„Çπ„ÉÜ';
                        else if (item.type === 'add') typeLabel.innerText = 'Âä†ÁÆó';
                        else if (item.type === 'multi') typeLabel.innerText = '‰πóÁÆó';
                        row.appendChild(typeLabel);
                    } else {
                        const typeSelect = document.createElement('select');
                        const ops = [
                            { val: 'add', text: 'Âä†ÁÆó' },
                            { val: 'multi', text: '‰πóÁÆó' },
                        ];
                        ops.forEach(o => {
                            const op = document.createElement('option');
                            op.value = o.val;
                            op.text = o.text;
                            if (item.type === o.val) op.selected = true;
                            typeSelect.appendChild(op);
                        });
                        typeSelect.onchange = (e) => {
                            cat.items[itemIndex].type = e.target.value;
                            saveState();
                            calculate();
                        };
                        row.appendChild(typeSelect);
                    }
                }

                // ON/OFF„Çπ„Ç§„ÉÉ„ÉÅ (ÂÖ®È†ÖÁõÆ - Âü∫Á§éÂÄ§„Å†„Åë„ÅØ„Çπ„Ç§„ÉÉ„ÉÅÈùûË°®Á§∫)
                if (item.type !== 'toggle') {
                    if (item.label === "Âü∫Á§éÂÄ§(Âõ∫ÂÆö)") {
                        // „Çπ„Ç§„ÉÉ„ÉÅ„ÅÆ‰ª£„Çè„Çä„Å´„ÉÄ„Éü„Éº
                        const dummy = document.createElement('div');
                        dummy.style.width = '36px';
                        row.appendChild(dummy);
                    } else {
                        const switchContainer = document.createElement('div');
                        switchContainer.className = 'switch-container';
                        const labelSwitch = document.createElement('label');
                        labelSwitch.className = 'switch';
                        const chk = document.createElement('input');
                        chk.type = 'checkbox';
                        chk.checked = item.on !== false;
                        chk.onchange = (e) => {
                            cat.items[itemIndex].on = e.target.checked;
                            saveState();
                            renderRows(catIndex, currentStats);
                            calculate();
                        };
                        const slider = document.createElement('span');
                        slider.className = 'slider';
                        labelSwitch.appendChild(chk);
                        labelSwitch.appendChild(slider);
                        switchContainer.appendChild(labelSwitch);
                        row.appendChild(switchContainer);
                    }
                }

                // ÂâäÈô§„Éú„Çø„É≥ (Âõ∫ÂÆöÈ†ÖÁõÆ„ÅØÂâäÈô§‰∏çÂèØÔºùÁ©∫Ê¨Ñ)
                if (!item.fixed) {
                    const delBtn = document.createElement('div');
                    delBtn.className = 'remove-btn';
                    delBtn.innerText = '√ó';
                    delBtn.onclick = () => {
                        cat.items.splice(itemIndex, 1);
                        saveState();
                        renderRows(catIndex, currentStats);
                        calculate();
                    };
                    row.appendChild(delBtn);
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'remove-placeholder';
                    row.appendChild(placeholder);
                }

                container.appendChild(row);
            });
        }

        function addItem(catIndex) {
            const currentStats = getActiveData();
            const cat = currentStats[catIndex];
            const type = cat.calcType === 'crit' ? 'multi' : 'add';
            // imgUrlÂàùÊúüÂÄ§„ÇÇ„Åó„Å£„Åã„ÇäÂÖ•„Çå„Çã
            cat.items.push({ label: 'Êñ∞Ë¶è', val: 0, fixed: false, edit: true, type: type, on: true, imgUrl: defaultImgUrl });
            saveState();
            renderRows(catIndex, currentStats);
        }

        function toggleDetails(index) {
            document.getElementById(`details-${index}`).classList.toggle('open');
            const arrow = document.getElementById(`arrow-${index}`);
            if (document.getElementById(`details-${index}`).classList.contains('open')) {
                arrow.style.transform = 'rotate(180deg)';
            } else {
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function calculate() {
            // ÁèæÂú®„ÅÆ„Çª„ÉÉ„Éà„Å†„Åë„Åß„Å™„Åè„ÄÅA„Å®B‰∏°Êñπ„ÇíË®àÁÆó„Åó„Å¶ÊØîËºÉ„ÇíË°®Á§∫„Åô„Çã

            const resA = calculateSet(appState.sets.A);
            const resB = calculateSet(appState.sets.B);

            updateHeaderInfo(resA, resB);
            updateBars(appState.activeSet === 'A' ? resA : resB);
        }

        function calculateSet(dataSet) {
            let globalMultiplier = 1.0;
            let efficiencies = [];
            let catResults = [];

            dataSet.forEach((cat, idx) => {
                let catTotal = 0;

                if (cat.calcType === 'crit') {
                    let additiveTotal = 0;
                    let multiplierProduct = 1.0;
                    cat.items.forEach(item => {
                        if (item.on === false) return;

                        if (item.type === 'stat_window') {
                            additiveTotal += (item.val - 150);
                        } else if (item.type === 'add') {
                            additiveTotal += item.val;
                        } else if (item.type === 'multi') {
                            multiplierProduct *= (1 + item.val / 100);
                        } else if (item.type === 'toggle') {
                            if (item.on) multiplierProduct *= (1 + item.val / 100);
                        }
                    });
                    const base = 150;
                    catTotal = additiveTotal + (base * multiplierProduct);
                } else {
                    catTotal = cat.items.reduce((sum, item) => {
                        if (item.on === false) return sum;
                        return sum + item.val;
                    }, 0);
                }

                if (catTotal <= 0) catTotal = 0;

                // 1%ÂäπÁéáË®àÁÆó
                if (catTotal === 0) {
                    globalMultiplier = 0;
                } else {
                    globalMultiplier *= (catTotal / 100);
                }

                const eff = catTotal > 0 ? (1 / catTotal) * 100 : 0;

                catResults.push({
                    total: catTotal,
                    eff: eff
                });

                efficiencies.push({ index: idx, val: eff, total: catTotal });
            });

            return { globalMultiplier, efficiencies, catResults };
        }

        function updateHeaderInfo(resA, resB) {
            const activeRes = appState.activeSet === 'A' ? resA : resB;
            totalDisplay.innerText = activeRes.globalMultiplier.toLocaleString(undefined, { maximumFractionDigits: 2, minimumFractionDigits: 2 });

            const compareEl = document.getElementById("compareInfo");
            if (compareEl) {
                const valA = resA.globalMultiplier;
                const valB = resB.globalMultiplier;

                let diffText = "";
                if (valA > 0) {
                    const diff = ((valB - valA) / valA) * 100;
                    const sign = diff >= 0 ? "+" : "";
                    const color = diff >= 0 ? 'var(--accent-cyan)' : 'var(--alert-red)';
                    // Â§âÊõ¥: "Â§âÊõ¥Âæå„ÅØÂ§âÊõ¥Ââç„Çà„Çä +„Äá% Âº∑„ÅÑ"
                    diffText = `Â§âÊõ¥Âæå„ÅØÂ§âÊõ¥Ââç„Çà„Çä <span style="color:${color}">${sign}${diff.toFixed(2)}%</span> Âº∑„ÅÑ`;
                } else {
                    diffText = "Comparision unavailable";
                }

                compareEl.innerHTML = `
                    <div style="font-size:0.85rem; color:#aaa;">Â§âÊõ¥Ââç: ${valA.toFixed(2)} / Â§âÊõ¥Âæå: ${valB.toFixed(2)}</div>
                    <div style="font-size:0.9rem; font-weight:bold; margin-top:2px;">${diffText}</div>
                `;
            }
        }

        function updateHeaderUI() {
            // „Éú„Çø„É≥„ÅÆ„Éè„Ç§„É©„Ç§„ÉàÂàá„ÇäÊõø„Åà
            const btnA = document.getElementById('btnSetA');
            const btnB = document.getElementById('btnSetB');
            if (btnA && btnB) {
                // „ÇØ„É©„ÇπÂàá„ÇäÊõø„Åà
                if (appState.activeSet === 'A') {
                    btnA.classList.add('active');
                    btnB.classList.remove('active');
                } else {
                    btnA.classList.remove('active');
                    btnB.classList.add('active');
                }
            }
        }

        function updateBars(res) {
            // Ë°®Á§∫„ÅÆÊõ¥Êñ∞ (ÂêÑ„Ç´„Éº„Éâ„ÅÆÊï∞ÂÄ§„Å™„Å©)
            res.catResults.forEach((r, idx) => {
                const totalEl = document.getElementById(`total-${idx}`);
                const effEl = document.getElementById(`eff-${idx}`);
                if (totalEl) totalEl.innerText = r.total.toFixed(2) + '%';
                if (effEl) effEl.innerText = '+' + r.eff.toFixed(3) + '%';
            });

            // „Éê„Éº„ÅÆÈï∑„Åï„Å®Ëâ≤
            const maxEff = Math.max(...res.efficiencies.map(e => e.val));
            const sorted = [...res.efficiencies].sort((a, b) => b.val - a.val);

            res.efficiencies.forEach(item => {
                const rank = sorted.findIndex(e => e.index === item.index) + 1;
                const card = document.getElementById(`card-${item.index}`);
                const bar = document.getElementById(`bar-${item.index}`);

                if (!card || !bar) return;

                card.setAttribute('data-rank', rank);
                bar.style.backgroundColor = '';
                card.style.borderLeftColor = '';

                const width = (maxEff > 0) ? (item.val / maxEff) * 100 : 0;
                bar.style.width = `${width}%`;

                if (item.total > 280) {
                    card.setAttribute('data-over', 'true');
                    bar.style.backgroundColor = 'var(--alert-red)';
                    bar.style.opacity = 0.2;
                    card.style.borderLeftColor = 'var(--alert-red)';
                } else {
                    card.setAttribute('data-over', 'false');
                    if (rank > 1) {
                        const opacity = (maxEff > 0) ? Math.max(0.1, (item.val / maxEff) * 0.2) : 0;
                        bar.style.opacity = opacity;
                        card.style.borderLeftColor = `rgba(0, 229, 255, ${Math.max(0.3, item.val / maxEff)})`;
                    } else {
                        bar.style.opacity = 0.15;
                    }
                }
            });
        }

        init();

    </script>

</body>

</html>