<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELSWORDステータス効率計算</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0d0d0d;
            --card-bg: #1a1a1a;
            --card-hover: #252525;
            --input-bg: #000000;
            --text-main: #ffffff;
            --text-sub: #aaa;

            --accent-cyan: #00e5ff;
            --accent-yellow: #ffea00;
            --alert-red: #ff4444;
            --border-dim: #333;

            --toggle-off: #444;
            --toggle-on: var(--accent-cyan);
        }

        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: 0.05em;
        }

        .container {
            width: 100%;
            max-width: 950px;
        }

        /* --- ヘルプボタンエリア --- */
        .nav-area {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
            padding: 0 5px;
        }

        .help-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-cyan), #00b8cc);
            border: none;
            color: #000;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 0 5px rgba(0, 229, 255, 0.5);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            margin-left: 10px;
        }

        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--accent-cyan);
        }

        /* --- ヘッダー --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #111;
            border-bottom: 1px solid var(--border-dim);
            margin-bottom: 10px;
            border-radius: 8px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .stat-bar {
            background-color: #333;
            height: 20px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .stat-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00e5ff, #00bcd4);
            transition: width 0.5s ease-out;
            position: relative;
            box-shadow: 0 0 8px rgba(0, 229, 255, 0.4);
        }



        h1 {
            font-size: 1.3rem;
            color: #e0e0e0;
            margin: 0;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            font-weight: 800;
            /* ExtraBold */
        }

        .total-display-compact {
            font-size: 1.5rem;
            font-weight: 800;
            color: #fff;
        }

        .total-label-compact {
            font-size: 0.8rem;
            color: #888;
            margin-right: 10px;
            font-weight: 700;
        }

        /* --- リスト --- */
        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 4px;
            overflow: hidden;
            border-left: 3px solid transparent;
            transition: border-color 0.3s ease;
        }

        .stat-header {
            position: relative;
            height: 44px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            overflow: hidden;
        }

        .stat-header:hover {
            background-color: var(--card-hover);
        }

        .bg-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--accent-cyan);
            opacity: 0.1;
            z-index: 0;
            width: 0%;
            transition: width 0.5s ease, background-color 0.3s ease;
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }

        .stat-icon-img {
            width: 24px;
            height: 24px;
            min-width: 24px;
            min-height: 24px;
            margin-right: 10px;
            object-fit: fill;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
        }

        .stat-name {
            font-weight: 800;
            /* タイトルと同じExtraBoldに変更 */
            font-size: 0.95rem;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
            display: flex;
            align-items: center;
            letter-spacing: 0.05em;
            /* 文字間隔調整 */
        }

        .meta-group {
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .label-text {
            font-size: 0.75rem;
            color: #888;
            margin-right: 4px;
            font-weight: 500;
        }

        .val-text {
            font-size: 1rem;
            color: #fff;
            min-width: 60px;
            text-align: right;
            font-weight: 700;
        }

        .eff-text {
            font-size: 0.9rem;
            color: var(--accent-cyan);
            min-width: 60px;
            text-align: right;
            font-weight: 700;
        }

        .spacer {
            width: 20px;
        }

        .arrow {
            font-size: 0.8rem;
            color: #555;
            margin-left: 10px;
            transition: transform 0.3s;
        }

        .stat-card[data-rank="1"]:not([data-over="true"]) {
            border-left-color: var(--accent-yellow);
        }

        .stat-card[data-rank="1"]:not([data-over="true"]) .eff-text {
            color: var(--accent-yellow);
        }

        .stat-card[data-rank="1"]:not([data-over="true"]) .bg-bar {
            background-color: var(--accent-yellow);
            opacity: 0.15;
        }

        .stat-card:not([data-rank="1"]) {
            border-left-color: var(--accent-cyan);
        }

        /* --- 詳細エリア --- */
        .details-section {
            background-color: #111;
            border-top: 1px solid #222;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }

        .details-section.open {
            max-height: 2000px;
            padding: 10px;
            overflow: visible;
        }

        .details-section.open+.header-content .arrow {
            transform: rotate(180deg);
        }

        .breakdown-row {
            display: grid;
            gap: 8px;
            margin-bottom: 4px;
            align-items: center;
        }

        .breakdown-row.crit {
            grid-template-columns: 1fr 70px 15px 60px 40px 30px;
        }

        .breakdown-row.simple {
            grid-template-columns: 1fr 70px 15px 40px 30px;
        }

        .breakdown-row.toggle-row {
            grid-template-columns: 1fr 100px 30px;
        }

        .breakdown-row.disabled input[type="text"],
        .breakdown-row.disabled input[type="number"],
        .breakdown-row.disabled select,
        .breakdown-row.disabled .unit-label,
        .breakdown-row.disabled .item-icon,
        .breakdown-row.disabled .type-label {
            opacity: 0.4;
        }

        .name-container {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .item-icon {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            object-fit: fill;
            opacity: 0.8;
        }

        .breakdown-row input[type="text"] {
            background: transparent;
            border: none;
            color: #aaa;
            border-bottom: 1px solid #333;
            padding: 2px 5px;
            width: 100%;
            font-size: 0.9rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 500;
            /* 通常より少し太く */
            letter-spacing: 0.05em;
            /* 漢字のつぶれ防止 */
            transition: opacity 0.2s;
        }

        .breakdown-row input[type="number"] {
            background: var(--input-bg);
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            padding: 4px;
            text-align: right;
            font-weight: 700;
            width: 70px;
            font-size: 0.9rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            transition: opacity 0.2s;
            margin-right: 10px !important;
        }

        .breakdown-row select {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 2px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            transition: opacity 0.2s;
        }

        .type-label {
            color: #888;
            font-size: 0.8rem;
            text-align: center;
            font-weight: 700;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }

        .unit-label {
            color: #555;
            font-size: 0.8rem;
            text-align: center;
            font-weight: 700;
        }

        .remove-btn {
            background: #2a2a2a;
            border: 1px solid #333;
            color: #888;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
            line-height: 24px;
            height: 26px;
            border-radius: 6px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .remove-btn:hover {
            background-color: var(--alert-red);
            color: #fff;
            border-color: var(--alert-red);
        }

        .remove-placeholder {
            height: 26px;
            width: 100%;
        }

        .add-btn {
            background: #222;
            border: 1px dashed #444;
            color: #666;
            width: 100%;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.85rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
        }

        .add-btn:hover {
            background: #333;
            color: #fff;
        }

        .formula-note {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .fixed-val {
            color: #555 !important;
            pointer-events: none;
            border: none !important;
            background: transparent !important;
        }

        /* --- トグルスイッチ --- */
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--toggle-off);
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--toggle-on);
            box-shadow: 0 0 8px var(--toggle-on);
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        .switch-label {
            margin-right: 10px;
            font-size: 0.8rem;
            color: #aaa;
            font-weight: 700;
        }

        /* --- モーダル --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #1a1a1a;
            margin: 5% auto;
            padding: 0;
            border: 1px solid var(--accent-cyan);
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
            color: #fff;
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 15px 20px;
            background: #111;
            border-bottom: 1px solid #333;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--accent-cyan);
        }

        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close-btn:hover {
            color: #fff;
        }

        .modal-body {
            padding: 20px;
        }

        .guide-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .guide-grid {
                grid-template-columns: 1fr;
            }
        }

        .guide-step {
            background: #222;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #555;
        }

        .step-num {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            font-weight: 800;
            margin-bottom: 5px;
            display: block;
        }

        .step-text {
            font-size: 0.95rem;
            line-height: 1.6;
            font-weight: 500;
        }

        .highlight-yellow {
            color: var(--accent-yellow);
            font-weight: 800;
        }

        .highlight-red {
            color: var(--alert-red);
            font-weight: 800;
        }

        .modal-footer {
            padding: 15px;
            text-align: center;
            border-top: 1px solid #333;
            font-size: 0.9rem;
            color: #888;
            font-weight: 500;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .tab-btn {
            background: #222;
            border: 1px solid #444;
            color: #888;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            font-family: inherit;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .tab-btn:hover {
            background: #333;
            color: #fff;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-cyan), #00b8cc);
            color: #000;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 8px rgba(0, 229, 255, 0.4);
        }

        .copy-btn {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            color: #fff;
            border-color: #666;
            background: #222;
        }

        /* アラート型モーダル（コピー確認用） */
        .alert-modal-content {
            background-color: #1a1a1a;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--accent-cyan);
            border-radius: 8px;
            width: 300px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            animation: modalFadeIn 0.3s;
        }

        .alert-btns {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .alert-btn {
            padding: 6px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            border: none;
        }

        .btn-yes {
            background: var(--accent-cyan);
            color: #000;
        }

        .btn-no {
            background: #333;
            color: #fff;
        }

        .compare-info {
            text-align: right;
            margin-right: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .item-row-img {
            width: 24px;
            height: 24px;
            min-width: 24px;
            min-height: 24px;
            object-fit: fill;
            margin-right: 8px;
            border-radius: 2px;
            background: #222;
            border: 1px solid #333;
        }

        .name-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 100%;
            margin-left: 4px;
        }

        .name-upper-row {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .item-desc {
            font-size: 0.7rem;
            color: #777;
            margin-top: 2px;
            line-height: 1.2;
            padding-left: 5px;
        }

        /* ▼▼ 追加するCSS（スマホ最適化） ▼▼ */
        @media (max-width: 600px) {

            /* --- 全体の余白調整 --- */
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.1rem;
            }

            .container {
                width: 100%;
            }

            /* --- ヘッダー周り --- */
            header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                padding: 15px;
            }

            .tab-container {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }

            /* 比較情報の配置調整 */
            div[style*="display:flex; align-items:center;"] {
                flex-direction: column;
                align-items: flex-end;
                width: 100%;
                gap: 10px;
            }

            .compare-info {
                text-align: right;
                margin-right: 0;
                font-size: 0.8rem;
            }

            /* --- リスト・入力行のスマホ化（2段組み） --- */
            /* グリッドを解除してフレックスボックスへ */
            .breakdown-row,
            .breakdown-row.crit,
            .breakdown-row.simple,
            .breakdown-row.toggle-row {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                padding: 10px 5px;
                border-bottom: 1px solid #222;
                /* 行の区切り線を追加 */
                height: auto;
            }

            /* 名前・アイコン・説明エリアを上段100%に */
            .name-container {
                width: 100%;
                margin-bottom: 5px;
                order: 1;
                /* 1番目 */
            }

            /* 名前入力欄の文字サイズ確保 */
            .breakdown-row input[type="text"] {
                font-size: 16px;
                /* iOSズーム防止 */
            }

            /* 入力欄、セレクトボックス、スイッチ等を下段へ */
            .breakdown-row>input[type="number"],
            .breakdown-row>select,
            .breakdown-row>.unit-label,
            .breakdown-row>.type-label,
            .switch-container {
                order: 2;
                /* 2番目（下段） */
            }

            /* 数値入力欄を大きく、押しやすく */
            .breakdown-row input[type="number"] {
                width: 80px;
                height: 36px;
                font-size: 16px;
                /* iOSズーム防止 */
                padding: 0 8px;
            }

            /* セレクトボックス調整 */
            .breakdown-row select {
                height: 36px;
                font-size: 14px;
            }

            /* 削除ボタンを右端に飛ばす */
            .remove-btn {
                margin-left: auto;
                order: 3;
                width: 36px;
                height: 36px;
                line-height: 34px;
            }

            .remove-placeholder {
                display: none;
                /* 固定項目のプレースホルダーは消す */
            }

            /* --- 項目ヘッダー（バー）の調整 --- */
            .header-content {
                padding-right: 0;
            }

            .stat-name {
                font-size: 0.85rem;
            }

            .meta-group {
                flex-direction: column;
                /* 合計と効率を縦に積む */
                align-items: flex-end;
                gap: 2px;
            }

            .spacer {
                display: none;
            }

            /* スペーサー削除 */
            .label-text {
                display: none;
            }

            /* "合計:" などのラベルを消して数値だけ強調 */
            .val-text {
                font-size: 0.9rem;
            }

            .eff-text {
                font-size: 0.8rem;
            }

            /* 魔法石パネルをスマホ向けに調整 */
            .stone-panel-grid {
                grid-template-columns: repeat(2, 1fr);
                /* スマホでは2カラム */
            }
        }

        /* タブレット向け調整 */
        @media (min-width: 601px) and (max-width: 900px) {
            .stone-panel-grid {
                grid-template-columns: repeat(3, 1fr);
                /* タブレットでは3カラム */
            }
        }

        /* ▼▼ 追加するCSS(魔法石パネル用) ▼▼ */
        .stone-panel-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            /* 5カラムの固定グリッド */
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #333;
        }

        .stone-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .stone-header {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 2px;
        }

        .stone-input-row,
        .stone-ctrl-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #222;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .stone-label-mini {
            font-size: 0.75rem;
            color: #888;
            font-weight: bold;
        }

        .stone-num-input {
            width: 40px;
            background: transparent;
            border: none;
            border-bottom: 1px solid #555;
            color: #fff;
            text-align: right;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .stone-ctrl-btn {
            width: 24px;
            height: 24px;
            background: #333;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .stone-target-val {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent-cyan);
            width: 30px;
            text-align: center;
        }

        .stone-diff {
            text-align: right;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 2px;
        }

        .stone-row {
            padding-left: 35px;
        }


        /* --- 魔法石パネル用 (v37) --- */
        .card-body-split {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 5px 0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 45%;
        }

        .control-arrow {
            color: #666;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* 数値入力欄の矢印（スピンボタン）削除 */
        #stoneControlPanel input[type=number]::-webkit-inner-spin-button,
        #stoneControlPanel input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #stoneControlPanel input[type=number] {
            -moz-appearance: textfield;
        }

        /* プリセットボタンエリア */
        .preset-container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-top: 0;
            margin-bottom: 0;
            padding: 0 5px;
        }

        .preset-btn {
            border: 1px solid #ffcc80;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 0.85rem;
            transition: transform 0.1s;
            background: #ffe082;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            min-width: 120px;
            text-align: center;
        }

        .preset-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <div style="display:flex; flex-direction:column; align-items:flex-start;">
                <div style="display:flex; align-items:center;">
                    <h1>ELSWORDステータス効率計算</h1>
                    <button id="helpBtn" class="help-btn">?</button>
                </div>
                <div class="tab-container">
                    <button id="btnSetA" class="tab-btn active" onclick="switchSet('A')">変更前</button>
                    <button id="btnSetB" class="tab-btn" onclick="switchSet('B')">変更後</button>
                    <button class="copy-btn" onclick="openCopyModal()">変更前をコピー</button>
                </div>
            </div>

            <div style="display:flex; align-items:center;">
                <div id="compareInfo" class="compare-info">
                    <!-- JS Injected -->
                </div>
                <div style="text-align:right;">
                    <span class="total-label-compact"
                        style="display:block; margin-right:0; font-size:0.65rem; line-height:1;">TOTAL MULTI</span>
                    <span class="total-display-compact" id="totalDisplay">0.00</span>
                </div>
            </div>
        </header>

        <div class="stats-list" id="statsList"></div>

        <!-- 魔法石個数調整パネル -->
        <div id="stoneControlPanel" class="stone-panel-grid"></div>

        <!-- プリセット読込ボタン -->
        <div style="border-top: 2px dashed #333; margin-top: 20px; padding-top: 20px;">
            <div class="preset-container">
                <span style="font-size:0.8rem; color:#888; margin-right:10px;">プリセット読込</span>
                <button class="preset-btn" onclick="loadPreset('jiro')">🐟たいやき次郎</button>
                <button class="preset-btn" onclick="loadPreset('fuyuru')">❄️ふゆるです</button>
                <button class="preset-btn" onclick="loadPreset('rikatan')">🎀りかたん</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">📌 使い方ガイド</div>
                <span class="close-btn" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="guide-grid">
                    <div class="guide-step" style="border-left-color: var(--accent-cyan);">
                        <span class="step-num">STEP 1</span>
                        <div class="step-text">
                            項目のバーをクリックして、詳細を開きます。<br>
                            数値入力やスイッチ(ON/OFF)でシミュレーションできます。
                        </div>
                    </div>
                    <div class="guide-step" style="border-left-color: var(--accent-cyan);">
                        <span class="step-num">STEP 2</span>
                        <div class="step-text">
                            右側の<strong>「1%上昇効率」</strong>をチェック！<br>
                            この数値が大きい項目を強化するのが最も効率的です。
                        </div>
                    </div>
                    <div class="guide-step" style="border-left-color: var(--accent-yellow);">
                        <span class="step-num">STEP 3</span>
                        <div class="step-text">
                            効率No.1は<span class="highlight-yellow">黄色のバー</span>、<br>
                            減衰ライン(280%)超えは<span class="highlight-red">赤色のバー</span>で表示されます。
                        </div>
                    </div>
                    <div class="guide-step" style="border-left-color: #fff;">
                        <span class="step-num">TIP</span>
                        <div class="step-text">
                            変更前と変更後を比べて、どちらが強いかシミュレーションしましょう！
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                計算機を使って最強のステータスを目指そう！🔥
            </div>
        </div>
    </div>

    <!-- Copy Confirmation Modal -->
    <div id="copyModal" class="modal">
        <div class="alert-modal-content">
            <div style="font-weight:bold; color:#fff; margin-bottom:15px;">確認</div>
            <div style="color:#aaa; font-size:0.9rem; line-height:1.5;">
                変更前（Set A）のデータをコピーして、<br>変更後（Set B）に上書きしますか？
            </div>
            <div class="alert-btns">
                <button class="alert-btn btn-no" onclick="closeCopyModal()">No</button>
                <button class="alert-btn btn-yes" onclick="execCopy()">Yes</button>
            </div>
        </div>
    </div>

    <script>
        // ▼ グローバル設定 ▼
        const defaultImgUrl = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // Transparent 1x1

        /*
          データ設定 (テンプレート)
        */
        const defaultStatsData = [
            {
                id: "atk_percent",
                name: "物魔攻撃力(%)",
                customImage: "",
                calcType: "simple",
                items: [
                    { label: "基礎値(固定)", val: 100, fixed: true, edit: false, on: true, imgUrl: "./images/kotei.png", desc: "" },
                    { label: "オプション変換効果", val: 12, fixed: true, edit: true, on: true, imgUrl: "./images/buki.png" },
                    { label: "武器魔力付与", val: 37.5, fixed: true, edit: true, on: true, imgUrl: "./images/maryoku.png", desc: "青(2％)+黄(2%)+巨大(6％1カ所)=37.5％" },
                    { label: "レアバセット効果", val: 6, fixed: true, edit: true, on: true, imgUrl: "./images/shinen.png", desc: "深淵3set=7%、クレスト3set=6%" },
                    { label: "レアバアクセ[固定効果]", val: 4, fixed: true, edit: true, on: true, imgUrl: "./images/reabakouka.png", desc: "猛虎指輪=3%　オートマタネックレス=1%" },
                    { label: "一般アクセ[追加効果]", val: 5, fixed: true, edit: true, on: true, imgUrl: "./images/attoma.png", desc: "アットマアクセ鑑定効果等" },
                    { label: "スキリン[固定効果]", val: 0.5, fixed: true, edit: false, on: true, imgUrl: "./images/sukiru.png" },
                    { label: "エルコレ効果", val: 3.75, fixed: true, edit: true, on: true, imgUrl: "./images/erukore.png" },
                    { label: "エクサ再錬効果", val: 8, fixed: true, edit: true, on: true, imgUrl: "./images/ekusa.png", desc: "再錬15段階×4カ所" },
                    { label: "ペットパッシブ", val: 2, fixed: true, edit: false, on: true, imgUrl: "./images/pet.png" },
                    { label: "アーティファクト成長1段階", val: 3, fixed: true, edit: false, on: true, imgUrl: "./images/arti.png" },
                    { label: "シナジー", val: 1, fixed: true, edit: false, on: true, imgUrl: "./images/shinagi.png", desc: "物理特化,魔法特化" },
                ]
            },
            {
                id: "cri_dmg",
                name: "クリティカルダメージ",
                customImage: "",
                calcType: "crit",
                items: [
                    { label: "ステータス表記", val: 215.00, type: "stat_window", fixed: true, edit: true, on: true, imgUrl: "./images/sute.png" },
                    { label: "加算パッシブ", val: 0, type: "add", fixed: true, edit: true, on: true, imgUrl: "./images/kasankuri.png" },
                    { label: "乗算パッシブ", val: 0, type: "multi", fixed: true, edit: true, on: true, imgUrl: "./images/josan.png" },
                    { label: "アットマ草木セット効果", val: 26, type: "multi", fixed: true, edit: true, on: true, imgUrl: "./images/attoma.png", desc: "エリート=26%　ユニーク=30%" },
                    { label: "エクサ赤セット", val: 10, type: "multi", fixed: true, edit: false, on: true, imgUrl: "./images/ekusa.png" },
                    { label: "刻印", val: 5, type: "multi", fixed: true, edit: false, on: true, imgUrl: "./images/kokuin.png" },
                    { label: "マエストロヘイロー", val: 2, type: "multi", fixed: true, edit: false, on: true, imgUrl: "./images/maesuto.png" },
                ]
            },
            {
                id: "boss_dmg",
                name: "ボスに与えるダメージ増加",
                customImage: "",
                calcType: "simple",
                items: [
                    { label: "基礎値(固定)", val: 100, fixed: true, edit: false, on: true, imgUrl: "./images/kotei.png" },
                    { label: "ステータス表記", val: 174.2, fixed: true, edit: true, on: true, imgUrl: "./images/sute.png" },
                    { label: "狩りのデュアル魔法石", val: 0, stoneId: "boss25", unit: 2.5, imgUrl: "./images/kariisi.png", desc: "", fixed: true, edit: false, on: true, currentCount: 0, targetCount: 0 },
                    { label: "力のアットマ魔法石", val: 0, stoneId: "boss3", unit: 3, imgUrl: "./images/ishitikara.png", desc: "", fixed: true, edit: false, on: true, currentCount: 0, targetCount: 0 },
                    { label: "加算パッシブ", val: 0.00, fixed: true, edit: true, on: true, imgUrl: "./images/kasanboss.png" },
                    { label: "ギルドスキル", val: 2.50, fixed: true, edit: true, on: true, imgUrl: "./images/guild.png" },
                    { label: "刻印", val: 5, fixed: true, edit: false, on: true, imgUrl: "./images/kokuin.png" },
                ]
            },
            {
                id: "all_skill",
                name: "全てのスキルダメージ増加",
                customImage: "",
                calcType: "simple",
                items: [
                    { label: "基礎値(固定)", val: 100, fixed: true, edit: false, on: true, imgUrl: "./images/kotei.png" },
                    { label: "ステータス表記", val: 106.5, fixed: true, edit: true, on: true, imgUrl: "./images/sute.png" },
                    { label: "力のアットマ魔法石", val: 0, stoneId: "skill2", unit: 2, imgUrl: "./images/ishitikara.png", desc: "", fixed: true, edit: false, on: true, currentCount: 0, targetCount: 0 }
                ]
            },
            {
                id: "trans_skill",
                name: "強烈、超越スキルダメージ増加",
                customImage: "",
                calcType: "simple",
                items: [
                    { label: "基礎値(固定)", val: 100, fixed: true, edit: false, on: true, imgUrl: "./images/kotei.png" },
                    { label: "ステータス表記", val: 128.6, fixed: true, edit: true, on: true, imgUrl: "./images/sute.png" },
                    { label: "機敏のアットマ魔法石", val: 0, stoneId: "trans2", unit: 2, imgUrl: "./images/ishikibin.png", desc: "", fixed: true, edit: false, on: true, currentCount: 0, targetCount: 0 },
                    { label: "知恵のアットマ魔法石", val: 0, stoneId: "trans25", unit: 2.5, imgUrl: "./images/ishitie.png", desc: "", fixed: true, edit: false, on: true, currentCount: 0, targetCount: 0 },
                ]
            },
            {
                id: "polar",
                name: "両極化：攻撃/受けるダメージ増加",
                customImage: "",
                calcType: "simple",
                items: [
                    { label: "基礎値(固定)", val: 100, fixed: true, edit: false, on: true, imgUrl: "./images/kotei.png" },
                    { label: "ステータス表記", val: 53.70, fixed: true, edit: true, on: true, imgUrl: "./images/sute.png" }
                ]
            },
            {
                id: "dot",
                name: "与えたダメージのn%を追加持続ダメージ",
                customImage: "",
                calcType: "simple",
                items: [
                    { label: "基礎値(固定)", val: 100, fixed: true, edit: false, on: true, imgUrl: "./images/kotei.png" },
                    { label: "オプション変換効果", val: 0, fixed: true, edit: true, on: true, imgUrl: "./images/buki.png" },
                    { label: "エクサ回路増幅効果", val: 11.7, fixed: true, edit: true, on: true, imgUrl: "./images/kairo.png" },
                    { label: "エクサチップオプション", val: 11, fixed: true, edit: true, on: true, imgUrl: "./images/chip.png" },
                    { label: "アットマ上衣アクセ[固定効果]", val: 6, fixed: true, edit: true, on: true, imgUrl: "./images/attoma.png" },
                    { label: "レアバセット効果", val: 7.00, fixed: true, edit: true, on: true, imgUrl: "./images/shinen.png", desc: "エレボス3set=7%　ヴィタホン3set=7%　深淵2set=5％　猛虎防具set=5%　深淵防具set=10%" },
                    { label: "レアバ武器[固定効果]", val: 0.00, fixed: true, edit: true, on: true, imgUrl: "./images/reabuki.png" },
                    { label: "レアバアクセ[固定効果]", val: 7.00, fixed: true, edit: true, on: true, imgUrl: "./images/zizoku.png" },
                    { label: "一般アクセ[追加効果]", val: 0, fixed: true, edit: true, on: true, imgUrl: "./images/attoma.png" },
                    { label: "レイド3点セット効果", val: 5.00, fixed: true, edit: false, on: true, imgUrl: "./images/set.png" },
                    { label: "リンクアバ効果", val: 2.00, fixed: true, edit: false, on: true, imgUrl: "./images/rinku.png" },
                    { label: "シナジー", val: 2.00, fixed: true, edit: false, on: true, imgUrl: "./images/shinagizizoku.png", desc: "歪曲された視線" },
                ]
            },
            {
                id: "hp100_under",
                name: "HP100％以下の敵を攻撃時、ダメージ増加",
                customImage: "",
                calcType: "simple",
                items: [
                    { label: "基礎値(固定)", val: 100, fixed: true, edit: false, on: true, imgUrl: "./images/kotei.png" },
                    { label: "レアバセット効果", val: 10, fixed: true, edit: true, on: true, imgUrl: "./images/shinen.png", desc: "猛虎3set=6%　エレボス2set=5%　クレスト2set=4%　クレスト防具set=6%" },
                    { label: "レアバ武器[固定効果]", val: 5, fixed: true, edit: false, on: true, imgUrl: "./images/reabuki.png" },
                    { label: "一般アクセ[追加効果]", val: 0, fixed: true, edit: true, on: true, imgUrl: "./images/attoma.png" },
                    { label: "アットマ上衣アクセ[固定効果]", val: 10, fixed: true, edit: true, on: true, imgUrl: "./images/attoma.png" },
                ]
            },
            {
                id: "hp50_over",
                name: "HP50％超過の敵を攻撃時、ダメージ増加",
                customImage: "",
                calcType: "simple",
                items: [
                    { label: "基礎値(固定)", val: 100, fixed: true, edit: false, on: true, imgUrl: "./images/kotei.png" },
                    { label: "エクサ回路増幅効果", val: 10, fixed: true, edit: true, on: true, imgUrl: "./images/kairo.png" },
                    { label: "エクサチップオプション", val: 5, fixed: true, edit: true, on: true, imgUrl: "./images/chip.png" },
                    { label: "シナジー", val: 2, fixed: true, edit: false, on: true, imgUrl: "./images/shinagi50koe.png", desc: "巨人審判者" }
                ]
            },
            {
                id: "hp50_under",
                name: "HP50％以下の敵を攻撃時、ダメージ増加",
                customImage: "",
                calcType: "simple",
                items: [
                    { label: "基礎値(固定)", val: 100, fixed: true, edit: false, on: true, imgUrl: "./images/kotei.png" },
                    { label: "エクサ回路増幅効果", val: 10, fixed: true, edit: true, on: true, imgUrl: "./images/kairo.png" },
                    { label: "エクサチップオプション", val: 5, fixed: true, edit: true, on: true, imgUrl: "./images/chip.png" },
                    { label: "シナジー", val: 2, fixed: true, edit: false, on: true, imgUrl: "./images/shinagi50ika.png", desc: "殴り合い" }
                ]
            },
            {
                id: "hp30",
                name: "HP30％以下の敵を攻撃時、ダメージ増加",
                customImage: "",
                calcType: "simple",
                items: [
                    { label: "基礎値(固定)", val: 100, fixed: true, edit: false, on: true, imgUrl: "./images/kotei.png" },
                    { label: "ソケット効果", val: 0, fixed: true, edit: true, on: true, imgUrl: "./images/hangeki.png" }
                ]
            },
        ];

        // ▼ ユーザープリセットデータ ▼
        // たいやき次郎：カスタマイズされた初期値
        const jiroStats = JSON.parse(JSON.stringify(defaultStatsData));
        // クリティカルダメージのカスタマイズ
        const jiroCriDmg = jiroStats.find(cat => cat.id === 'cri_dmg');
        if (jiroCriDmg) {
            jiroCriDmg.items.find(i => i.label === 'ステータス表記').val = 212.5;
            jiroCriDmg.items.find(i => i.label === '加算パッシブ').val = 20;
            jiroCriDmg.items.find(i => i.label === '乗算パッシブ').val = 10;
        }
        // ボスダメージのカスタマイズ
        const jiroBossDmg = jiroStats.find(cat => cat.id === 'boss_dmg');
        if (jiroBossDmg) {
            jiroBossDmg.items.find(i => i.label === '加算パッシブ').val = 20;
            // 刻印をOFFに
            const kokuin = jiroBossDmg.items.find(i => i.label === '刻印');
            if (kokuin) kokuin.on = false;
            // 狩りのデュアル魔法石の値を設定（16個 × 2.5% = 40）
            const boss25Stone = jiroBossDmg.items.find(i => i.stoneId === 'boss25');
            if (boss25Stone) {
                boss25Stone.val = 40;
                boss25Stone.currentCount = 16;
                boss25Stone.targetCount = 16;
            }
            // 力のアットマ魔法石の値を設定（6個 × 3% = 18）
            const bossStone = jiroBossDmg.items.find(i => i.stoneId === 'boss3');
            if (bossStone) {
                bossStone.val = 18;
                bossStone.currentCount = 6;
                bossStone.targetCount = 6;
            }
        }
        // 全スキルダメージの魔法石カスタマイズ
        const jiroAllSkill = jiroStats.find(cat => cat.id === 'all_skill');
        if (jiroAllSkill) {
            const skillStone = jiroAllSkill.items.find(i => i.stoneId === 'skill2');
            if (skillStone) {
                skillStone.val = 2;
                skillStone.currentCount = 1;
                skillStone.targetCount = 1;
            }
        }
        // 強烈超越スキルダメージの魔法石カスタマイズ
        const jiroTransSkill = jiroStats.find(cat => cat.id === 'trans_skill');
        if (jiroTransSkill) {
            const transStone = jiroTransSkill.items.find(i => i.stoneId === 'trans2');
            if (transStone) {
                transStone.val = 6;
                transStone.currentCount = 3;
                transStone.targetCount = 3;
            }
        }
        // HP100％以下の敵のカスタマイズ
        const jiroHp100 = jiroStats.find(cat => cat.id === 'hp100_under');
        if (jiroHp100) {
            jiroHp100.items.find(i => i.label === 'レアバセット効果').val = 21;
            jiroHp100.items.find(i => i.label === 'レアバ武器[固定効果]').val = 5;
            jiroHp100.items.find(i => i.label === '一般アクセ[追加効果]').val = 1;
            jiroHp100.items.find(i => i.label === 'アットマ上衣アクセ[固定効果]').val = 10;
        }
        // HP50％超過の敵のカスタマイズ
        const jiroHp50Over = jiroStats.find(cat => cat.id === 'hp50_over');
        if (jiroHp50Over) {
            jiroHp50Over.items.find(i => i.label === 'エクサ回路増幅効果').val = 11.1;
            jiroHp50Over.items.find(i => i.label === 'エクサチップオプション').val = 5;
        }
        // HP50％以下の敵のカスタマイズ
        const jiroHp50Under = jiroStats.find(cat => cat.id === 'hp50_under');
        if (jiroHp50Under) {
            jiroHp50Under.items.find(i => i.label === 'エクサ回路増幅効果').val = 10.2;
            jiroHp50Under.items.find(i => i.label === 'エクサチップオプション').val = 4;
            // シナジー（殴り合い）をOFFに
            const shinagi = jiroHp50Under.items.find(i => i.label === 'シナジー');
            if (shinagi) shinagi.on = false;
        }

        // ふゆるです：次郎と同じ内容で初期化
        const fuyuruStats = JSON.parse(JSON.stringify(defaultStatsData));

        // りかたん：カスタマイズされた初期値
        const rikatanStats = JSON.parse(JSON.stringify(defaultStatsData));

        // 1. 物魔攻撃力(%)のカスタマイズ
        const rikatanAtkPercent = rikatanStats.find(cat => cat.id === 'atk_percent');
        if (rikatanAtkPercent) {
            rikatanAtkPercent.items.find(i => i.label === 'オプション変換効果').val = 13;
            rikatanAtkPercent.items.find(i => i.label === '武器魔力付与').val = 36.25;
            rikatanAtkPercent.items.find(i => i.label === 'レアバセット効果').val = 6;
            rikatanAtkPercent.items.find(i => i.label === 'レアバアクセ[固定効果]').val = 4;
            rikatanAtkPercent.items.find(i => i.label === '一般アクセ[追加効果]').val = 1;
            rikatanAtkPercent.items.find(i => i.label === 'エルコレ効果').val = 3.75;
            rikatanAtkPercent.items.find(i => i.label === 'エクサ再錬効果').val = 8;
        }

        // 2. クリティカルダメージのカスタマイズ
        const rikatanCriDmg = rikatanStats.find(cat => cat.id === 'cri_dmg');
        if (rikatanCriDmg) {
            rikatanCriDmg.items.find(i => i.label === 'ステータス表記').val = 228.5;
            rikatanCriDmg.items.find(i => i.label === '加算パッシブ').val = 10;
            rikatanCriDmg.items.find(i => i.label === '乗算パッシブ').val = 0;
            rikatanCriDmg.items.find(i => i.label === 'アットマ草木セット効果').val = 26;
            // 刻印をOFFに
            const kokuin = rikatanCriDmg.items.find(i => i.label === '刻印');
            if (kokuin) kokuin.on = false;
        }

        // 3. ボスに与えるダメージ増加のカスタマイズ
        const rikatanBossDmg = rikatanStats.find(cat => cat.id === 'boss_dmg');
        if (rikatanBossDmg) {
            rikatanBossDmg.items.find(i => i.label === 'ステータス表記').val = 152.2;
            rikatanBossDmg.items.find(i => i.label === '加算パッシブ').val = 0;
            rikatanBossDmg.items.find(i => i.label === 'ギルドスキル').val = 2.5;
            // 刻印はON（デフォルト）
            // 狩りのデュアル魔法石の値を設定（13個 × 2.5% = 32.5）
            const boss25Stone = rikatanBossDmg.items.find(i => i.stoneId === 'boss25');
            if (boss25Stone) {
                boss25Stone.val = 32.5;
                boss25Stone.currentCount = 13;
                boss25Stone.targetCount = 13;
            }
            // 力のアットマ魔法石は0個
            const bossStone = rikatanBossDmg.items.find(i => i.stoneId === 'boss3');
            if (bossStone) {
                bossStone.val = 0;
                bossStone.currentCount = 0;
                bossStone.targetCount = 0;
            }
        }

        // 4. 全てのスキルダメージ増加のカスタマイズ
        const rikatanAllSkill = rikatanStats.find(cat => cat.id === 'all_skill');
        if (rikatanAllSkill) {
            rikatanAllSkill.items.find(i => i.label === 'ステータス表記').val = 105.75;
            // 魔法石は0個
            const skillStone = rikatanAllSkill.items.find(i => i.stoneId === 'skill2');
            if (skillStone) {
                skillStone.val = 0;
                skillStone.currentCount = 0;
                skillStone.targetCount = 0;
            }
        }

        // 5. 強烈、超越スキルダメージ増加のカスタマイズ
        const rikatanTransSkill = rikatanStats.find(cat => cat.id === 'trans_skill');
        if (rikatanTransSkill) {
            rikatanTransSkill.items.find(i => i.label === 'ステータス表記').val = 128.6;
            // 機敏のアットマ魔法石（2個 × 2% = 4）
            const trans2Stone = rikatanTransSkill.items.find(i => i.stoneId === 'trans2');
            if (trans2Stone) {
                trans2Stone.val = 4;
                trans2Stone.currentCount = 2;
                trans2Stone.targetCount = 2;
            }
            // 知恵のアットマ魔法石は0個
            const trans25Stone = rikatanTransSkill.items.find(i => i.stoneId === 'trans25');
            if (trans25Stone) {
                trans25Stone.val = 0;
                trans25Stone.currentCount = 0;
                trans25Stone.targetCount = 0;
            }
        }

        // 6. 両極化のカスタマイズ
        const rikatanPolar = rikatanStats.find(cat => cat.id === 'polar');
        if (rikatanPolar) {
            rikatanPolar.items.find(i => i.label === 'ステータス表記').val = 37.3;
        }

        // 7. 持続ダメージのカスタマイズ
        const rikatanDot = rikatanStats.find(cat => cat.id === 'dot');
        if (rikatanDot) {
            rikatanDot.items.find(i => i.label === 'オプション変換効果').val = 0;
            rikatanDot.items.find(i => i.label === 'エクサ回路増幅効果').val = 10.7;
            rikatanDot.items.find(i => i.label === 'エクサチップオプション').val = 14;
            rikatanDot.items.find(i => i.label === 'アットマ上衣アクセ[固定効果]').val = 4;
            rikatanDot.items.find(i => i.label === 'レアバセット効果').val = 12;
            rikatanDot.items.find(i => i.label === 'レアバ武器[固定効果]').val = 5;
            rikatanDot.items.find(i => i.label === 'レアバアクセ[固定効果]').val = 8;
            rikatanDot.items.find(i => i.label === '一般アクセ[追加効果]').val = 0;
        }

        // 8. HP100％以下の敵のカスタマイズ
        const rikatanHp100 = rikatanStats.find(cat => cat.id === 'hp100_under');
        if (rikatanHp100) {
            rikatanHp100.items.find(i => i.label === 'レアバセット効果').val = 10;
            rikatanHp100.items.find(i => i.label === 'レアバ武器[固定効果]').val = 0;
            rikatanHp100.items.find(i => i.label === '一般アクセ[追加効果]').val = 3.5;
            rikatanHp100.items.find(i => i.label === 'アットマ上衣アクセ[固定効果]').val = 10;
        }

        // 9. HP50％超過の敵のカスタマイズ
        const rikatanHp50Over = rikatanStats.find(cat => cat.id === 'hp50_over');
        if (rikatanHp50Over) {
            rikatanHp50Over.items.find(i => i.label === 'エクサ回路増幅効果').val = 0.7;
            rikatanHp50Over.items.find(i => i.label === 'エクサチップオプション').val = 0;
        }

        // 10. HP50％以下の敵のカスタマイズ
        const rikatanHp50Under = rikatanStats.find(cat => cat.id === 'hp50_under');
        if (rikatanHp50Under) {
            rikatanHp50Under.items.find(i => i.label === 'エクサ回路増幅効果').val = 9.6;
            rikatanHp50Under.items.find(i => i.label === 'エクサチップオプション').val = 0;
            // シナジー（殴り合い）をOFFに
            const shinagi = rikatanHp50Under.items.find(i => i.label === 'シナジー');
            if (shinagi) shinagi.on = false;
        }

        // 11. HP30％以下の敵のカスタマイズ
        const rikatanHp30 = rikatanStats.find(cat => cat.id === 'hp30');
        if (rikatanHp30) {
            rikatanHp30.items.find(i => i.label === 'ソケット効果').val = 0;
        }

        // ▼ グローバル状態管理 ▼
        let appState = {
            activeSet: 'A',
            stoneCounts: {
                // v37: 魔法石の個数をセット別に管理
                boss3: { A: 0, B: 0 },
                boss25: { A: 0, B: 0 },
                skill2: { A: 0, B: 0 },
                trans2: { A: 0, B: 0 },
                trans25: { A: 0, B: 0 }
            },
            sets: {
                A: null,
                B: null
            }
        };

        const listContainer = document.getElementById('statsList');
        const totalDisplay = document.getElementById('totalDisplay');
        const modal = document.getElementById("helpModal");
        const copyModal = document.getElementById("copyModal");
        const helpBtn = document.getElementById("helpBtn");
        const closeBtn = document.getElementById("closeModal");

        function init() {
            loadState(); // データ読み込み or 初期化
            setupModal();
            render();
            calculate();
        }

        // --- データ永続化 (LocalStorage) ---
        function saveState() {
            localStorage.setItem('elsword_calc_state_v59', JSON.stringify(appState));
        }

        function loadState() {
            const saved = localStorage.getItem('elsword_calc_state_v59');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.activeSet && parsed.sets && parsed.sets.A && parsed.sets.B) {
                        appState = parsed;
                        // v37: stoneCountsがない場合は初期化
                        if (!appState.stoneCounts) {
                            appState.stoneCounts = {
                                boss3: { A: 0, B: 0 },
                                boss25: { A: 0, B: 0 },
                                skill2: { A: 0, B: 0 },
                                trans2: { A: 0, B: 0 },
                                trans25: { A: 0, B: 0 }
                            };
                        }
                        // --- データ同期: デフォルト画像の反映 ---
                        // 保存されたデータに画像情報がない、またはデフォルトの透明画像のままの場合、
                        // defaultStatsDataにある新しいURLを適用する
                        syncDefaultImages();
                    } else {
                        throw new Error("Invalid format");
                    }
                } catch (e) {
                    console.log("Data corrupted or init, loading default.", e);
                    initDefault();
                }
            } else {
                initDefault();
            }
        }

        function syncDefaultImages() {
            // AとB両方のセットに対して実行
            ['A', 'B'].forEach(setKey => {
                if (!appState.sets[setKey]) return;
                appState.sets[setKey].forEach((cat, catIdx) => {
                    // 対応するデフォルトデータのカテゴリを探す
                    const defCat = defaultStatsData.find(d => d.id === cat.id);
                    if (!defCat) return;

                    cat.items.forEach((item, itemIdx) => {
                        // 対応するデフォルトアイテムを探す（ラベル一致）
                        const defItem = defCat.items.find(d => d.label === item.label);
                        if (defItem && defItem.imgUrl && defItem.imgUrl !== defaultImgUrl) {
                            // 保存データの画像が空orデフォルト画像なら、新しいデフォルト画像で上書き
                            if (!item.imgUrl || item.imgUrl === defaultImgUrl) {
                                item.imgUrl = defItem.imgUrl;
                            }
                        }
                    });
                });
            });
            // 同期した結果を保存
            saveState();
        }

        function initDefault() {
            // ディープコピーで初期化
            appState.sets.A = JSON.parse(JSON.stringify(defaultStatsData));
            appState.sets.B = JSON.parse(JSON.stringify(defaultStatsData));
            appState.activeSet = 'A';
            appState.stoneCounts = {
                boss3: { A: 0, B: 0 },
                boss25: { A: 0, B: 0 },
                skill2: { A: 0, B: 0 },
                trans2: { A: 0, B: 0 },
                trans25: { A: 0, B: 0 }
            };
        }

        function setupModal() {
            helpBtn.onclick = function () { modal.style.display = "block"; }
            closeBtn.onclick = function () { modal.style.display = "none"; }
            window.onclick = function (event) {
                if (event.target == modal) { modal.style.display = "none"; }
                if (event.target == copyModal) { copyModal.style.display = "none"; }
            }
        }

        // --- コピー機能 ---
        function openCopyModal() {
            copyModal.style.display = "block";
        }

        function closeCopyModal() {
            copyModal.style.display = "none";
        }

        function execCopy() {
            // A -> B Deep Copy
            appState.sets.B = JSON.parse(JSON.stringify(appState.sets.A));
            saveState();
            // 描画更新
            render();
            calculate();
            closeCopyModal();
        }

        // --- プリセット読込機能 ---
        function loadPreset(user) {
            const names = { 'jiro': 'たいやき次郎', 'fuyuru': 'ふゆるです', 'rikatan': 'りかたん' };
            const name = names[user] || user;
            if (!confirm(name + ' のプリセットを読み込みますか？\n※現在の入力内容は上書きされます。')) return;

            let sourceData;
            if (user === 'jiro') sourceData = jiroStats;
            else if (user === 'fuyuru') sourceData = fuyuruStats;
            else if (user === 'rikatan') sourceData = rikatanStats;

            // A/B両方のセットをそのユーザーの初期値でリセット
            appState.sets.A = JSON.parse(JSON.stringify(sourceData));
            appState.sets.B = JSON.parse(JSON.stringify(sourceData));

            // 魔法石カウントの設定
            if (user === 'jiro') {
                // たいやき次郎の魔法石個数
                appState.stoneCounts = {
                    boss3: { A: 6, B: 6 },
                    boss25: { A: 16, B: 16 },
                    skill2: { A: 1, B: 1 },
                    trans2: { A: 3, B: 3 },
                    trans25: { A: 0, B: 0 }
                };
            } else if (user === 'rikatan') {
                // りかたんの魔法石個数
                appState.stoneCounts = {
                    boss3: { A: 0, B: 0 },
                    boss25: { A: 13, B: 13 },
                    skill2: { A: 0, B: 0 },
                    trans2: { A: 2, B: 2 },
                    trans25: { A: 0, B: 0 }
                };
            } else {
                // その他のプリセットは0にリセット
                appState.stoneCounts = {
                    boss3: { A: 0, B: 0 },
                    boss25: { A: 0, B: 0 },
                    skill2: { A: 0, B: 0 },
                    trans2: { A: 0, B: 0 },
                    trans25: { A: 0, B: 0 }
                };
            }

            saveState();
            render();
            calculate();
        }

        // --- A/B 切り替え ---
        function switchSet(setName) {
            appState.activeSet = setName;
            saveState();
            updateHeaderUI();
            render();
            calculate();
        }

        function getActiveData() {
            return appState.sets[appState.activeSet];
        }

        function render() {
            listContainer.innerHTML = '';
            const currentStats = getActiveData();

            currentStats.forEach((cat, index) => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.id = `card-${index}`;

                const header = document.createElement('div');
                header.className = 'stat-header';
                header.onclick = () => toggleDetails(index);
                header.innerHTML = `
                <div class="bg-bar" id="bar-${index}"></div>
                <div class="header-content">
                    <div class="stat-name">
                        ${cat.customImage ? `<img src="${cat.customImage}" class="stat-icon-img" alt="icon">` : ''}
                        ${cat.name}
                    </div>
                    <div class="meta-group">
                        <span class="label-text">合計:</span>
                        <span class="val-text" id="total-${index}">0%</span>
                        <div class="spacer"></div>
                        <span class="label-text">1%上昇効率:</span>
                        <span class="eff-text" id="eff-${index}">+0%</span>
                        <span class="arrow" id="arrow-${index}">▼</span>
                    </div>
                </div>
            `;

                const details = document.createElement('div');
                details.className = 'details-section';
                details.id = `details-${index}`;

                const note = document.createElement('div');
                note.className = 'formula-note';
                if (cat.calcType === 'crit') {
                    note.innerText = '式: (ステ表記 - 150) + 加算 + (150 × 乗算補正)';
                } else {
                    note.innerText = '式: 基礎値(100%) + 加算値の合計';
                }
                details.appendChild(note);

                const rowsContainer = document.createElement('div');
                rowsContainer.id = `rows-${index}`;
                details.appendChild(rowsContainer);

                const addBtn = document.createElement('button');
                addBtn.className = 'add-btn';
                addBtn.innerText = '＋ 項目を追加';
                addBtn.onclick = (e) => { e.stopPropagation(); addItem(index); };
                details.appendChild(addBtn);

                card.appendChild(header);
                card.appendChild(details);
                listContainer.appendChild(card);

                renderRows(index, currentStats);
            });
            updateHeaderUI();
            renderStonePanel();
        }

        /* --- 魔法石パネル連動 (v39: 縦並びUI) --- */
        function renderStonePanel() {
            const container = document.getElementById('stoneControlPanel');
            if (!container) return;
            container.innerHTML = '';

            const stones = [
                { id: 'boss25', label: 'ボスダメ2.5%', unit: 2.5, img: './images/kariisi.png' },
                { id: 'boss3', label: 'ボスダメ3%', unit: 3, img: './images/ishitikara.png' },
                { id: 'skill2', label: '全スキル2%', unit: 2, img: './images/ishitikara.png' },
                { id: 'trans2', label: '強烈超越2%', unit: 2, img: './images/ishikibin.png' },
                { id: 'trans25', label: '強烈超越2.5%', unit: 2.5, img: './images/ishitie.png' }
            ];

            stones.forEach(stone => {
                // v37: stoneCountsから取得
                const countA = appState.stoneCounts[stone.id] ? appState.stoneCounts[stone.id].A : 0;
                const countB = appState.stoneCounts[stone.id] ? appState.stoneCounts[stone.id].B : 0;

                // 差分計算 (B - A)
                const diffPct = (countB - countA) * stone.unit;
                const diffStr = (diffPct >= 0 ? '+' : '') + parseFloat(diffPct.toFixed(2)) + '%';
                const diffColor = diffPct > 0 ? '#00e5ff' : (diffPct < 0 ? '#ff4444' : '#666');

                const card = document.createElement('div');
                card.className = 'stone-card';
                card.innerHTML = `
            <div style="display:flex; align-items:center; gap:5px; margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:5px;">
                <img src="${stone.img}" style="width:20px; height:20px;">
                <span style="font-size:0.8rem; font-weight:bold;">${stone.label}</span>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:8px;">
                <!-- Set A Control -->
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="line-height:1.2; text-align:left;">
                        <div style="font-size:0.75rem; color:#ddd; font-weight:bold;">変更前</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:3px;">
                        <button class="stone-ctrl-btn" onclick="updateStoneCount('${stone.id}', 'A', ${countA - 1})">-</button>
                        <input type="number" class="stone-num-input" value="${countA}" min="0" 
                            onchange="updateStoneCount('${stone.id}', 'A', this.value)" style="width:40px; text-align:center;">
                        <button class="stone-ctrl-btn" onclick="updateStoneCount('${stone.id}', 'A', ${countA + 1})">+</button>
                    </div>
                </div>

                <!-- Set B Control -->
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="line-height:1.2; text-align:left;">
                        <div style="font-size:0.75rem; color:#fff; font-weight:bold;">変更後</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:3px;">
                        <button class="stone-ctrl-btn" onclick="updateStoneCount('${stone.id}', 'B', ${countB - 1})">-</button>
                        <input type="number" class="stone-num-input" value="${countB}" min="0" 
                            onchange="updateStoneCount('${stone.id}', 'B', this.value)" style="width:40px; text-align:center;">
                        <button class="stone-ctrl-btn" onclick="updateStoneCount('${stone.id}', 'B', ${countB + 1})">+</button>
                    </div>
                </div>
            </div>

            <div style="text-align:right; font-size:0.8rem; color:${diffColor}; margin-top:8px; font-weight:bold;">
                補正: ${diffStr}
            </div>
        `;
                container.appendChild(card);
            });
        }

        function updateStoneCount(stoneId, setType, value) {
            // setType: 'A' or 'B'
            let val = parseInt(value);
            if (isNaN(val) || val < 0) val = 0;

            if (!appState.stoneCounts[stoneId]) appState.stoneCounts[stoneId] = { A: 0, B: 0 };
            appState.stoneCounts[stoneId][setType] = val;

            // 実際のリストデータを更新
            const stones = [
                { id: 'boss3', unit: 3 },
                { id: 'boss25', unit: 2.5 },
                { id: 'skill2', unit: 2 },
                { id: 'trans2', unit: 2 },
                { id: 'trans25', unit: 2.5 }
            ];
            const stoneDef = stones.find(s => s.id === stoneId);
            if (!stoneDef) return;

            const targetSet = appState.sets[setType];

            // 全カテゴリ走査して該当stoneIdを探す
            if (targetSet) {
                targetSet.forEach(cat => {
                    if (cat.items) {
                        const item = cat.items.find(i => i.stoneId === stoneId);
                        if (item) {
                            // 計算式: 個数 * 単位 (絶対値)
                            item.val = val * stoneDef.unit;
                        }
                    }
                });
            }

            saveState();
            render(); // 全体再描画
            calculate();
        }

        function renderRows(catIndex, currentStats) {
            const container = document.getElementById(`rows-${catIndex}`);
            const cat = currentStats[catIndex];
            container.innerHTML = '';

            cat.items.forEach((item, itemIndex) => {
                const row = document.createElement('div');

                if (item.type === 'toggle') {
                    row.className = 'breakdown-row toggle-row';
                } else {
                    let rowClass = cat.calcType === 'crit' ? 'breakdown-row crit' : 'breakdown-row simple';
                    if (item.on === false) rowClass += ' disabled';
                    // --- 魔法石行のクラス追加 (New) ---
                    if (item.stoneId) rowClass += ' stone-row';

                    row.className = rowClass;
                }

                // --- 画像表示 (New) ---    
                const imgDisplay = document.createElement('img');
                imgDisplay.src = item.imgUrl || defaultImgUrl;
                imgDisplay.className = 'item-row-img';
                imgDisplay.onerror = () => { imgDisplay.src = defaultImgUrl; }; // エラー時フォールバック

                // 名前入力エリア
                const nameContainer = document.createElement('div');
                nameContainer.className = 'name-container';
                nameContainer.appendChild(imgDisplay);

                // --- ラッパー作成 (Desc対応) ---
                const wrapper = document.createElement('div');
                wrapper.className = 'name-wrapper';

                const upperRow = document.createElement('div');
                upperRow.className = 'name-upper-row';
                wrapper.appendChild(upperRow);


                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = item.label;
                nameInput.placeholder = '項目名';
                if (item.fixed) nameInput.readOnly = true;
                nameInput.oninput = (e) => {
                    cat.items[itemIndex].label = e.target.value;
                    saveState();
                };

                // nameInputをupperRowへ
                upperRow.appendChild(nameInput);

                // 画像URL入力欄
                const imgUrlInput = document.createElement('input');
                imgUrlInput.type = 'text';
                imgUrlInput.className = 'img-url-input';
                imgUrlInput.placeholder = '画像URL';
                imgUrlInput.value = item.imgUrl === defaultImgUrl ? '' : (item.imgUrl || '');
                imgUrlInput.oninput = (e) => {
                    const url = e.target.value;
                    cat.items[itemIndex].imgUrl = url;
                    imgDisplay.src = url || defaultImgUrl;
                    saveState();
                };
                imgUrlInput.style.cssText = "width: 60px; font-size: 0.7rem; color: #555; background: transparent; border: 1px solid #333; border-radius: 4px; padding: 2px; margin-left: 5px;";

                // imgUrlInputをupperRowへ
                upperRow.appendChild(imgUrlInput);

                // 説明文 (Desc)
                if (item.desc) {
                    const descDiv = document.createElement('div');
                    descDiv.className = 'item-desc';
                    descDiv.innerText = item.desc;
                    wrapper.appendChild(descDiv);
                }

                // ラッパーをnameContainerへ
                nameContainer.appendChild(wrapper);

                row.appendChild(nameContainer);


                if (item.type === 'toggle') {
                    const switchContainer = document.createElement('div');
                    switchContainer.className = 'switch-container';

                    const label = document.createElement('span');
                    label.className = 'switch-label';
                    label.innerText = (item.val > 0 ? '+' : '') + item.val + '%';

                    const labelSwitch = document.createElement('label');
                    labelSwitch.className = 'switch';

                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.checked = item.on;
                    chk.onchange = (e) => {
                        cat.items[itemIndex].on = e.target.checked;
                        saveState();
                        renderRows(catIndex, currentStats);
                        calculate();
                    };

                    const slider = document.createElement('span');
                    slider.className = 'slider';

                    labelSwitch.appendChild(chk);
                    labelSwitch.appendChild(slider);
                    switchContainer.appendChild(label);
                    switchContainer.appendChild(labelSwitch);

                    row.appendChild(switchContainer);
                } else {
                    const valInput = document.createElement('input');
                    valInput.type = 'number';
                    valInput.value = item.val;
                    valInput.step = '0.1';

                    // ユーザー要望: 矢印キーで1.0刻みの変更 (3.5 -> 4.5)
                    valInput.onkeydown = (e) => {
                        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                            e.preventDefault();
                            let current = parseFloat(e.target.value) || 0;
                            if (e.key === 'ArrowUp') current += 1;
                            else current -= 1;

                            // 小数点ズレ防止
                            current = Math.round(current * 100) / 100;

                            e.target.value = current;
                            cat.items[itemIndex].val = current;
                            saveState();
                            calculate();
                        }
                    };

                    if (item.edit === false) {
                        valInput.className = 'fixed-val';
                        valInput.readOnly = true;
                    }
                    valInput.oninput = (e) => {
                        let v = parseFloat(e.target.value);
                        if (isNaN(v)) v = 0;
                        cat.items[itemIndex].val = v;
                        saveState();
                        calculate();
                    };
                    row.appendChild(valInput);

                    const unitLabel = document.createElement('div');
                    unitLabel.className = 'unit-label';
                    unitLabel.innerText = '%';
                    row.appendChild(unitLabel);
                }

                if (cat.calcType === 'crit' && item.type !== 'toggle') {
                    if (item.fixed) {
                        // 固定項目はタイプ固定
                        const typeLabel = document.createElement('div');
                        typeLabel.className = 'type-label';
                        if (item.type === 'stat_window') typeLabel.innerText = 'ステ';
                        else if (item.type === 'add') typeLabel.innerText = '加算';
                        else if (item.type === 'multi') typeLabel.innerText = '乗算';
                        row.appendChild(typeLabel);
                    } else {
                        const typeSelect = document.createElement('select');
                        const ops = [
                            { val: 'add', text: '加算' },
                            { val: 'multi', text: '乗算' },
                        ];
                        ops.forEach(o => {
                            const op = document.createElement('option');
                            op.value = o.val;
                            op.text = o.text;
                            if (item.type === o.val) op.selected = true;
                            typeSelect.appendChild(op);
                        });
                        typeSelect.onchange = (e) => {
                            cat.items[itemIndex].type = e.target.value;
                            saveState();
                            calculate();
                        };
                        row.appendChild(typeSelect);
                    }
                }

                // ON/OFFスイッチ (全項目 - 基礎値だけはスイッチ非表示)
                if (item.type !== 'toggle') {
                    if (item.label === "基礎値(固定)") {
                        // スイッチの代わりにダミー
                        const dummy = document.createElement('div');
                        dummy.style.width = '36px';
                        row.appendChild(dummy);
                    } else {
                        const switchContainer = document.createElement('div');
                        switchContainer.className = 'switch-container';
                        const labelSwitch = document.createElement('label');
                        labelSwitch.className = 'switch';
                        const chk = document.createElement('input');
                        chk.type = 'checkbox';
                        chk.checked = item.on !== false;
                        chk.onchange = (e) => {
                            cat.items[itemIndex].on = e.target.checked;
                            saveState();
                            renderRows(catIndex, currentStats);
                            calculate();
                        };
                        const slider = document.createElement('span');
                        slider.className = 'slider';
                        labelSwitch.appendChild(chk);
                        labelSwitch.appendChild(slider);
                        switchContainer.appendChild(labelSwitch);
                        row.appendChild(switchContainer);
                    }
                }

                // 削除ボタン (固定項目は削除不可＝空欄)
                if (!item.fixed) {
                    const delBtn = document.createElement('div');
                    delBtn.className = 'remove-btn';
                    delBtn.innerText = '×';
                    delBtn.onclick = () => {
                        cat.items.splice(itemIndex, 1);
                        saveState();
                        renderRows(catIndex, currentStats);
                        calculate();
                    };
                    row.appendChild(delBtn);
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'remove-placeholder';
                    row.appendChild(placeholder);
                }

                container.appendChild(row);
            });
        }

        function addItem(catIndex) {
            const currentStats = getActiveData();
            const cat = currentStats[catIndex];
            const type = cat.calcType === 'crit' ? 'multi' : 'add';
            // imgUrl初期値もしっかり入れる
            cat.items.push({ label: '新規', val: 0, fixed: false, edit: true, type: type, on: true, imgUrl: defaultImgUrl });
            saveState();
            renderRows(catIndex, currentStats);
        }

        function toggleDetails(index) {
            document.getElementById(`details-${index}`).classList.toggle('open');
            const arrow = document.getElementById(`arrow-${index}`);
            if (document.getElementById(`details-${index}`).classList.contains('open')) {
                arrow.style.transform = 'rotate(180deg)';
            } else {
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function calculate() {
            // 現在のセットだけでなく、AとB両方を計算して比較を表示する

            const resA = calculateSet(appState.sets.A);
            const resB = calculateSet(appState.sets.B);

            updateHeaderInfo(resA, resB);
            updateBars(appState.activeSet === 'A' ? resA : resB);
        }

        function calculateSet(dataSet) {
            let globalMultiplier = 1.0;
            let efficiencies = [];
            let catResults = [];

            dataSet.forEach((cat, idx) => {
                let catTotal = 0;

                if (cat.calcType === 'crit') {
                    let additiveTotal = 0;
                    let multiplierProduct = 1.0;
                    cat.items.forEach(item => {
                        if (item.on === false) return;

                        if (item.type === 'stat_window') {
                            additiveTotal += (item.val - 150);
                        } else if (item.type === 'add') {
                            additiveTotal += item.val;
                        } else if (item.type === 'multi') {
                            multiplierProduct *= (1 + item.val / 100);
                        } else if (item.type === 'toggle') {
                            if (item.on) multiplierProduct *= (1 + item.val / 100);
                        }
                    });
                    const base = 150;
                    catTotal = additiveTotal + (base * multiplierProduct);
                } else {
                    catTotal = cat.items.reduce((sum, item) => {
                        if (item.on === false) return sum;
                        return sum + item.val;
                    }, 0);
                }

                if (catTotal <= 0) catTotal = 0;

                // 1%効率計算
                if (catTotal === 0) {
                    globalMultiplier = 0;
                } else {
                    globalMultiplier *= (catTotal / 100);
                }

                const eff = catTotal > 0 ? (1 / catTotal) * 100 : 0;

                catResults.push({
                    total: catTotal,
                    eff: eff
                });

                efficiencies.push({ index: idx, val: eff, total: catTotal });
            });

            return { globalMultiplier, efficiencies, catResults };
        }

        function updateHeaderInfo(resA, resB) {
            const activeRes = appState.activeSet === 'A' ? resA : resB;
            totalDisplay.innerText = activeRes.globalMultiplier.toLocaleString(undefined, { maximumFractionDigits: 2, minimumFractionDigits: 2 });

            const compareEl = document.getElementById("compareInfo");
            if (compareEl) {
                const valA = resA.globalMultiplier;
                const valB = resB.globalMultiplier;

                let diffText = "";
                if (valA > 0) {
                    const diff = ((valB - valA) / valA) * 100;
                    const sign = diff >= 0 ? "+" : "";
                    const color = diff >= 0 ? 'var(--accent-cyan)' : 'var(--alert-red)';
                    // 変更: "変更後は変更前より +〇% 強い"
                    diffText = `変更後は変更前より <span style="color:${color}">${sign}${diff.toFixed(2)}%</span> 強い`;
                } else {
                    diffText = "Comparision unavailable";
                }

                compareEl.innerHTML = `
                    <div style="font-size:0.85rem; color:#aaa;">変更前: ${valA.toFixed(2)} / 変更後: ${valB.toFixed(2)}</div>
                    <div style="font-size:0.9rem; font-weight:bold; margin-top:2px;">${diffText}</div>
                `;
            }
        }

        function updateHeaderUI() {
            // ボタンのハイライト切り替え
            const btnA = document.getElementById('btnSetA');
            const btnB = document.getElementById('btnSetB');
            if (btnA && btnB) {
                // クラス切り替え
                if (appState.activeSet === 'A') {
                    btnA.classList.add('active');
                    btnB.classList.remove('active');
                } else {
                    btnA.classList.remove('active');
                    btnB.classList.add('active');
                }
            }
        }

        function updateBars(res) {
            // 表示の更新 (各カードの数値など)
            res.catResults.forEach((r, idx) => {
                const totalEl = document.getElementById(`total-${idx}`);
                const effEl = document.getElementById(`eff-${idx}`);
                if (totalEl) totalEl.innerText = r.total.toFixed(2) + '%';
                if (effEl) effEl.innerText = '+' + r.eff.toFixed(3) + '%';
            });

            // バーの長さと色
            const maxEff = Math.max(...res.efficiencies.map(e => e.val));
            const sorted = [...res.efficiencies].sort((a, b) => b.val - a.val);

            res.efficiencies.forEach(item => {
                const rank = sorted.findIndex(e => e.index === item.index) + 1;
                const card = document.getElementById(`card-${item.index}`);
                const bar = document.getElementById(`bar-${item.index}`);

                if (!card || !bar) return;

                card.setAttribute('data-rank', rank);
                bar.style.backgroundColor = '';
                card.style.borderLeftColor = '';

                const width = (maxEff > 0) ? (item.val / maxEff) * 100 : 0;
                bar.style.width = `${width}%`;

                if (item.total > 280) {
                    card.setAttribute('data-over', 'true');
                    bar.style.backgroundColor = 'var(--alert-red)';
                    bar.style.opacity = 0.2;
                    card.style.borderLeftColor = 'var(--alert-red)';
                } else {
                    card.setAttribute('data-over', 'false');
                    if (rank > 1) {
                        const opacity = (maxEff > 0) ? Math.max(0.1, (item.val / maxEff) * 0.2) : 0;
                        bar.style.opacity = opacity;
                        card.style.borderLeftColor = `rgba(0, 229, 255, ${Math.max(0.3, item.val / maxEff)})`;
                    } else {
                        bar.style.opacity = 0.15;
                    }
                }
            });
        }

        init();


    </script>

</body>

</html>